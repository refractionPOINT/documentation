# Reference: Platform Events

Platform events are system-level events generated by the LimaCharlie platform to provide visibility into sensor operations, organizational changes, and internal system activities. These events differ from telemetry events in that they relate to platform operations rather than endpoint activity.

## Event Categories

Platform events can be categorized into:

- **Sensor Lifecycle Events**: Enrollment, cloning, crashes, deletions
- **System Control Events**: Flow control, performance modes, updates
- **Organizational Events**: Quota changes, billing records
- **Artifact Events**: Ingestion and export operations
- **Cloud Adapter Events**: Adapter status and scheduling
- **Scheduled Events**: Periodic events per sensor, org, or cloud adapter

## Event Details

### ACK_MESSAGES

Acknowledge messages event is used by some LimaCharlie Sensors (e.g. USP). It is not used by the EDR.

---

### BACKOFF

Used for flow control. Provides a number of seconds that the Sensor should wait before sending events to the cloud.

---

### billing_record

This event is emitted for all kinds of billable records for the Organization.

**Sample Event:**

```json
{
  "record": {
    "cat": "extension",
    "k": "ext-strelka:bytes_scanned",
    "oid": "8cbe27f4-aaaa-bbbb-cccc-138cd51389cd",
    "record_id": "3bbbe4d9-925b-4538-bcad-e2e1ba2be923-0",
    "ts": "2024-05-30 00:44:37",
    "v": 2797
  }
}
```

**Event Structure:**
- `cat`: Category of the billable item (e.g., "extension")
- `k`: Key identifying the specific billable metric
- `oid`: Organization ID
- `record_id`: Unique identifier for this billing record
- `ts`: Timestamp of the billing record
- `v`: Value/amount for the billable metric

---

### CLOUD_ADAPTER_DISABLED

This event is emitted when a Cloud Adapter gets disabled because it has been erroring for a long period of time.

**Sample Event:**

```json
{
  "event":{
    "error": "invalid api key"
  },
  "routing": {
    "event_time": 1644444297696,
    "event_type": "cloud_adapter_disabled",
    "oid": "8cbe27f4-aaaa-cccc-bbbb-138cd51389cd"
  }
}
```

**Event Structure:**
- `error`: Description of the error that caused the adapter to be disabled
- `routing.oid`: Organization ID
- `routing.event_time`: Unix timestamp in milliseconds

---

### DATA_DROPPED

This event is generated by the Sensor when it has been offline and the events generated overflowed its internal buffer before they could be sent to the cloud, resulting in dropped events.

---

### DELETED_SENSOR

Deleted Sensor deployment events are produced when a sensor that was previously deleted from an Org attempts to connect to the LimaCharlie cloud.

**Sample Event:**

```json
{
  "routing": {
    "oid": "d9ae5c17-d519-4ef5-a4ac-c454a95d31ca",
    "iid": "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "sid": "a75cc927-bf28-4178-a42d-25ecc8a6be81",
    "plat": 536870912,
    "arch": 2,
    "ext_ip": "104.196.34.101",
    "int_ip": "172.17.0.2",
    "hostname": "linux-server-1",
    "event_type": "deleted_sensor",
    "event_time": 1561741553230
  },
  "event": {
    "denied_for": "720h0m0s"
  }
}
```

**Event Structure:**
- `routing.oid`: Organization ID
- `routing.iid`: Installation ID
- `routing.sid`: Sensor ID
- `routing.plat`: Platform identifier (numeric)
- `routing.arch`: Architecture identifier (numeric)
- `routing.ext_ip`: External IP address
- `routing.int_ip`: Internal IP address
- `routing.hostname`: Host name of the sensor
- `event.denied_for`: Duration the sensor will be denied (Go duration format)

---

### ENROLLMENT

Enrollment deployment events are produced when a sensor enrolls into the Organization for the first time.

**Sample Event:**

```json
{
  "routing": {
    "oid": "d9ae5c17-d519-4ef5-a4ac-c454a95d31ca",
    "iid": "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "sid": "a75cc927-bf28-4178-a42d-25ecc8a6be81",
    "plat": 536870912,
    "arch": 2,
    "event_type": "enrollment",
    "event_time": 1561741553230
  },
  "event": {
    "public_ip": "104.196.34.101",
    "internal_ip": "172.17.0.2",
    "host_name": "linux-server-1"
  }
}
```

**Event Structure:**
- `routing.oid`: Organization ID
- `routing.iid`: Installation ID
- `routing.sid`: Sensor ID
- `routing.plat`: Platform identifier
- `routing.arch`: Architecture identifier
- `event.public_ip`: Public-facing IP address
- `event.internal_ip`: Internal network IP address
- `event.host_name`: Host name of the enrolling sensor

---

### EXPORT_COMPLETE

An export of artifact data is completed and ready for download.

**Sample Event:**

```json
{
  "routing" : {
    "log_id" : "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "event_type" : "export_complete",
    "log_type" : "pcap",
    "oid" : "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "event_time" : 1561741553230
  },
  "event" : {
    "size" : 2048,
    "source" : "a75cc927-bf28-4178-a42d-25ecc8a6be81",
    "original_path" : "/data/pcap/dat.pcap",
    "export_id" : "d9ae5c17-d519-4ef5-a4ac-c454a95d31ca"
  }
}
```

**Event Structure:**
- `routing.log_id`: Unique identifier for the log
- `routing.log_type`: Type of artifact (e.g., "pcap")
- `routing.oid`: Organization ID
- `event.size`: Size of the exported file in bytes
- `event.source`: Sensor ID that generated the artifact
- `event.original_path`: Original file path on the endpoint
- `event.export_id`: Unique identifier for this export

---

### INGEST

A new artifact has been ingested.

**Sample Event:**

```json
{
  "routing" : {
    "log_id" : "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "event_type" : "ingest",
    "log_type" : "pcap",
    "oid" : "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "event_time" : 1561741553230
  },
  "event" : {
    "size" : 2048,
    "source" : "a75cc927-bf28-4178-a42d-25ecc8a6be81",
    "original_path" : "/data/pcap/dat.pcap",
    "original_md5" : "adjfnwonefowrnfowef"
  }
}
```

**Event Structure:**
- `routing.log_id`: Unique identifier for the log
- `routing.log_type`: Type of artifact being ingested (e.g., "pcap")
- `routing.oid`: Organization ID
- `event.size`: Size of the ingested file in bytes
- `event.source`: Sensor ID that generated the artifact
- `event.original_path`: Original file path on the endpoint
- `event.original_md5`: MD5 hash of the original file

---

### QUOTA_CHANGED

Quota changed events are emitted when the quota for an Organization changes.

**Sample Event:**

```json
{
  "event":{
    "new_quota": 30,
    "old_quota": 25
  },
  "routing": {
    "event_time": 1644444297696,
    "event_type": "quota_changed",
    "oid": "8cbe27f4-aaaa-cccc-bbbb-138cd51389cd"
  }
}
```

**Event Structure:**
- `event.new_quota`: New quota value
- `event.old_quota`: Previous quota value
- `routing.oid`: Organization ID
- `routing.event_time`: Unix timestamp in milliseconds

---

### RUN

Emitted after a run command has been issued (e.g. to run a payload, shell command, etc.).

---

### SELF_TEST_RESULT

Internal event used during a power-on-self-test (POST) of the sensor.

---

### SENSOR_CLONE

Sensor clone events are generated when the LimaCharlie Cloud detects that a specific Sensor ID may have been cloned.

**Sample Event:**

```json
{
  "routing": {
    "oid": "d9ae5c17-d519-4ef5-a4ac-c454a95d31ca",
    "iid": "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "sid": "a75cc927-bf28-4178-a42d-25ecc8a6be81",
    "plat": 536870912,
    "arch": 2,
    "event_type": "sensor_clone",
    "event_time": 1561741553230
  },
  "event": {
    "previous_hostname" : "server-1",
    "new_hostname" : "server-2"
  }
}
```

**Event Structure:**
- `routing.oid`: Organization ID
- `routing.iid`: Installation ID
- `routing.sid`: Sensor ID
- `routing.plat`: Platform identifier
- `routing.arch`: Architecture identifier
- `event.previous_hostname`: Original hostname before cloning was detected
- `event.new_hostname`: New hostname indicating a potential clone

---

### SENSOR_CRASH

This event is generated when a Sensor has crashed. It will include some telemetry useful to help LimaCharlie troubleshoot the crash.

**Sample Event:**

```json
{
  "routing": {
    "arch": 2,
    "event_time": 1670861698000,
    "event_type": "sensor_crash",
    "hostname": "linux-server-1",
    "ext_ip": "104.196.34.101",
    "int_ip": "172.17.0.2",
    "oid": "8cbe27f4-aaaa-cccc-bbbb-138cd51389cd",
    "plat": 268435456,
    "iid": "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "sid": "a75cc927-bf28-4178-a42d-25ecc8a6be81"
  },
  "event": {
    "crash_context": {
      "FILE_ID": 63,
      "LINE_NUMBER": 1216,
      "THREAD_ID": 7808
    }
  }
}
```

**Event Structure:**
- `routing.arch`: Architecture identifier
- `routing.hostname`: Host name where crash occurred
- `routing.ext_ip`: External IP address
- `routing.int_ip`: Internal IP address
- `routing.oid`: Organization ID
- `routing.plat`: Platform identifier
- `routing.iid`: Installation ID
- `routing.sid`: Sensor ID
- `event.crash_context.FILE_ID`: Internal file identifier where crash occurred
- `event.crash_context.LINE_NUMBER`: Line number in source code
- `event.crash_context.THREAD_ID`: Thread identifier that crashed

---

### SENSOR_OVER_QUOTA

Over quota deployment events are produced when a Sensor tries to connect but the Organization quota is already reached.

**Sample Event:**

```json
{
  "routing": {
    "oid": "d9ae5c17-d519-4ef5-a4ac-c454a95d31ca",
    "iid": "ca812425-5a36-4c73-a0a0-935a8ace6451",
    "sid": "a75cc927-bf28-4178-a42d-25ecc8a6be81",
    "plat": 536870912,
    "arch": 2,
    "event_type": "sensor_over_quota",
    "event_time": 1561741553230
  },
  "event": {
    "public_ip": "104.196.34.101",
    "internal_ip": "172.17.0.2",
    "host_name": "linux-server-1"
  }
}
```

**Event Structure:**
- `routing.oid`: Organization ID
- `routing.iid`: Installation ID
- `routing.sid`: Sensor ID
- `routing.plat`: Platform identifier
- `routing.arch`: Architecture identifier
- `event.public_ip`: Public-facing IP address of the sensor
- `event.internal_ip`: Internal network IP address
- `event.host_name`: Host name of the sensor attempting to connect

---

### SET_PERFORMANCE_MODE

Enables performance mode in the kernel (e.g., disables file tracking on Windows).

---

### SYNC

Internal event used as a heartbeat to the cloud. Sent by default every 10 minutes.

---

### UNLOAD_KERNEL

Allows manual unloading of kernel component.

---

### UPDATE

Internal event used to update the configuration of a specific collector within the endpoint.

---

### *_per_cloud_adapter

Events that are emitted once per period per cloud adapter. See [Schedule Events Reference](/v2/docs/reference-schedule-events) for more details.

**Sample Event:**

```json
{
  "event": {
    "frequency": 1800,
    "adapter_name": "office-audit",
    "runtime_mtd": {
      "entity_name": "81c72a07-9540-4341-9c35-66f6cfe1b9d7",
      "entity_type": "adapter",
      "mtd": {
        "platform": "office365",
        "hostname": "office-365-audit",
        "adapter_type": "office365"
      },
      "published_at": 1689858693935
    }
  }
}
```

**Event Structure:**
- `event.frequency`: How often the event is emitted (in seconds)
- `event.adapter_name`: Name of the cloud adapter
- `event.runtime_mtd.entity_name`: Unique identifier for the adapter entity
- `event.runtime_mtd.entity_type`: Type of entity (always "adapter" for this event)
- `event.runtime_mtd.mtd.platform`: Cloud platform type
- `event.runtime_mtd.mtd.hostname`: Hostname associated with the adapter
- `event.runtime_mtd.mtd.adapter_type`: Specific adapter type
- `event.runtime_mtd.published_at`: Unix timestamp in milliseconds when metadata was published

---

### *_per_org

Events that are emitted once per period per org. See [Schedule Events Reference](/v2/docs/reference-schedule-events) for more details.

**Sample Event:**

```json
{
  "event": {
    "frequency": 86400
  },
  "routing": {
    "event_id": "0f236fbb-31df-4d11-b6ab-c6b71a63a072",
    "event_time": 1673298756512,
    "event_type": "1h_per_org",
    "oid": "8cbe27f4-bfa1-4afb-ba19-138cd51389cd",
    "sid": "00000000-0000-0000-0000-000000000000",
    "tags": []
  }
}
```

**Event Structure:**
- `event.frequency`: How often the event is emitted (in seconds)
- `routing.event_id`: Unique identifier for this event instance
- `routing.event_time`: Unix timestamp in milliseconds
- `routing.event_type`: Specific scheduled event type (e.g., "1h_per_org")
- `routing.oid`: Organization ID
- `routing.sid`: Sensor ID (all zeros for org-level events)
- `routing.tags`: Array of tags associated with the organization

---

### *_per_sensor

Events that are emitted once per period per Sensor. See [Schedule Events Reference](/v2/docs/reference-schedule-events) for more details.

**Sample Event:**

```json
{
  "event": {
    "frequency": 1800,
    "runtime_mtd": {
      "entity_name": "81c72a07-9540-4341-9c35-66f6cfe1b9d7",
      "entity_type": "sensor",
      "mtd": {
        "bytes_recv": 6202524,
        "conn_at": 1689819872,
        "eps_in": 1,
        "eps_out": 0,
        "q_size": 0
      },
      "published_at": 1689858693935
    }
  }
}
```

**Event Structure:**
- `event.frequency`: How often the event is emitted (in seconds)
- `event.runtime_mtd.entity_name`: Unique identifier for the sensor entity
- `event.runtime_mtd.entity_type`: Type of entity (always "sensor" for this event)
- `event.runtime_mtd.mtd.bytes_recv`: Total bytes received by the sensor
- `event.runtime_mtd.mtd.conn_at`: Unix timestamp when sensor connected
- `event.runtime_mtd.mtd.eps_in`: Events per second incoming
- `event.runtime_mtd.mtd.eps_out`: Events per second outgoing
- `event.runtime_mtd.mtd.q_size`: Queue size (number of events buffered)
- `event.runtime_mtd.published_at`: Unix timestamp in milliseconds when metadata was published

---

## Common Routing Fields

Most platform events include a `routing` section with common fields:

- `oid`: Organization ID (UUID format)
- `iid`: Installation ID (UUID format)
- `sid`: Sensor ID (UUID format)
- `plat`: Platform identifier (numeric code)
- `arch`: Architecture identifier (numeric code)
- `event_type`: Type of platform event
- `event_time`: Unix timestamp in milliseconds
- `event_id`: Unique identifier for the event instance
- `ext_ip`: External/public IP address
- `int_ip`: Internal/private IP address
- `hostname`: Host name of the system

## Usage Notes

- Platform events are automatically generated by the LimaCharlie platform and cannot be manually triggered
- These events can be used in Detection & Response (D&R) rules for automation
- Scheduled events (`*_per_sensor`, `*_per_org`, `*_per_cloud_adapter`) are useful for periodic health checks and monitoring
- Sensor lifecycle events (enrollment, crash, clone, deletion) are critical for fleet management
- All timestamps are in Unix milliseconds unless otherwise specified