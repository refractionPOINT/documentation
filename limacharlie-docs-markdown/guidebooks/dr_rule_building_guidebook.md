# LimaCharlie D&R Rule Building: Complete Guidebook

## Table of Contents

1. [Introduction](#introduction)
2. [D&R Rule Fundamentals](#dr-rule-fundamentals)
3. [Target Types](#target-types)
4. [Detection Operators](#detection-operators)
5. [Rule Structure & Configuration](#rule-structure--configuration)
6. [Response Actions](#response-actions)
7. [Advanced Features](#advanced-features)
8. [Cybersecurity Examples by Target Type](#cybersecurity-examples-by-target-type)
9. [Complex Multi-Stage Rules](#complex-multi-stage-rules)
10. [Performance Optimization](#performance-optimization)
11. [Best Practices](#best-practices)
12. [Troubleshooting](#troubleshooting)

---

## Introduction

LimaCharlie's Detection & Response (D&R) engine is a powerful, flexible system that enables real-time threat detection and automated response across multiple data sources. This guidebook provides comprehensive coverage of all D&R rule components, configuration options, and practical cybersecurity examples.

The D&R engine processes rules against various target types, supports complex stateful detection patterns, and can trigger sophisticated response actions. Understanding each component and how they interact is crucial for building effective security automation.

---

## D&R Rule Fundamentals

### Basic Structure

Every D&R rule follows this fundamental structure:

```yaml
detect:
  # Detection logic using operators and paths
  op: <operator_name>
  path: <data_path>
  value: <comparison_value>
  # Additional operator-specific parameters

respond:
  # Response actions (optional)
  - action: <action_name>
    # Action-specific parameters

# Global rule configuration
target: <target_type>  # Default: edr
comment: "Rule description"
```

### Core Concepts

- **Path**: JSONPath-style selectors to extract data from events
- **Operators**: Logic operations for detection (is, contains, matches, etc.)
- **Values**: Comparison targets (can include templates)
- **Templates**: Dynamic value generation using Go template syntax
- **Targets**: Data sources the rule processes (edr, detection, artifact, etc.)

---

## Target Types

D&R rules can process five different target types, each with unique characteristics and use cases.

### 1. EDR Target (Default)

**Purpose**: Process telemetry events from LimaCharlie sensors
**Data Source**: Real-time endpoint events
**Common Events**: NEW_PROCESS, FILE_CREATE, NETWORK_ACTIVITY, DNS_REQUEST, etc.

```yaml
target: edr  # Can be omitted as it's default
events:
  - NEW_PROCESS
  - FILE_CREATE
```

### 2. Detection Target

**Purpose**: Process detections generated by other D&R rules (enables rule chaining)
**Data Source**: Detection objects from previous rules
**Use Cases**: Alert escalation, correlation, suppression

```yaml
target: detection
detect:
  op: contains
  path: event/detect/cat
  value: "persistence"
```

### 3. Deployment Target

**Purpose**: Process sensor lifecycle events
**Data Source**: Sensor enrollment, installation, and configuration events
**Use Cases**: Monitoring sensor health, deployment validation

```yaml
target: deployment
events:
  - sensor_enrolled
  - sensor_deleted
```

### 4. Artifact Target

**Purpose**: Process artifacts collected via REST API or sensor commands
**Data Source**: Files, memory dumps, registry exports, logs
**Use Cases**: Malware analysis, forensic investigation, compliance checking

```yaml
target: artifact
artifact source: "incident_response"
artifact type: "file"
```

### 5. Artifact Event Target

**Purpose**: Process lifecycle events around artifacts
**Data Source**: Artifact ingestion, processing completion, errors
**Use Cases**: Workflow automation, processing monitoring

```yaml
target: artifact_event
events:
  - artifact_ingested
  - processing_complete
```

---

## Detection Operators

The D&R engine supports 25+ detection operators organized into categories.

### String Operations

#### `is` - Exact Matching
Performs exact value comparison for strings, integers, and booleans.

```yaml
detect:
  op: is
  path: event/FILE_PATH
  value: "C:\\Windows\\System32\\calc.exe"
  case sensitive: true  # Default: true
```

**Parameters:**
- `case sensitive`: Boolean (default: true)
- `not`: Boolean negation

#### `contains` - Substring Matching
Checks if a string contains a substring, with optional occurrence counting.

```yaml
detect:
  op: contains
  path: event/COMMAND_LINE
  value: "powershell"
  case sensitive: false
  count: 2  # Must appear at least twice
```

**Parameters:**
- `case sensitive`: Boolean (default: true)
- `count`: Minimum occurrences (default: 1)
- `not`: Boolean negation

#### `starts with` / `ends with` - Prefix/Suffix Matching
Checks string prefixes or suffixes.

```yaml
detect:
  op: starts with
  path: event/FILE_PATH
  value: "C:\\Users\\"
  case sensitive: false
```

#### `matches` - Regular Expression
Pattern matching using regular expressions (case-insensitive by default).

```yaml
detect:
  op: matches
  path: event/COMMAND_LINE
  re: "(?i)invoke-.*expression"
  case sensitive: false  # Default for regex
```

**Important**: Use the `re` parameter (not `value`) for regex patterns. Use `(?i)` flag for case-insensitive matching in regex patterns.

### Logical Operations

#### `and` - Logical AND
All sub-rules must match.

```yaml
detect:
  op: and
  rules:
    - op: is
      path: event/NEW_PROCESS/IMAGE_FILE_PATH
      value: "powershell.exe"
      file name: true
    - op: contains
      path: event/NEW_PROCESS/COMMAND_LINE
      value: "-encodedcommand"
```

#### `or` - Logical OR
Any sub-rule must match.

```yaml
detect:
  op: or
  rules:
    - op: contains
      path: event/COMMAND_LINE
      value: "mimikatz"
    - op: contains
      path: event/COMMAND_LINE
      value: "sekurlsa"
```

#### `not` - Negation
Can be applied to any operator as a parameter.

```yaml
detect:
  op: contains
  path: event/FILE_PATH
  value: ".exe"
  not: true  # Files NOT containing .exe
```

### Existence & Structure

#### `exists` - Path Existence
Checks if a path exists, optionally validating non-empty values.

```yaml
detect:
  op: exists
  path: event/NEW_PROCESS/PARENT
  truthy: true  # Must be non-empty/non-null
```

#### `scope` - Scoped Evaluation
Executes sub-rule on each element of a Dict or List.

```yaml
detect:
  op: scope
  path: event/NEW_PROCESS/MODULES
  rule:
    op: contains
    path: MODULE_PATH
    value: "suspicious.dll"
```

### Comparison Operations

#### `is greater than` / `is lower than` - Numeric Comparison
Compares numeric values or string lengths.

```yaml
detect:
  op: is greater than
  path: event/NEW_PROCESS/COMMAND_LINE
  value: 1000  # Command line longer than 1000 chars
```

#### `string distance` - Levenshtein Distance
Measures string similarity using edit distance.

```yaml
detect:
  op: string distance
  path: event/FILE_PATH
  value: "C:\\Windows\\System32\\svchost.exe"
  max: 3  # Maximum 3 character differences
```

### Platform Detection

Platform operators enable OS and architecture-specific rules:

```yaml
# Windows-specific detection
detect:
  op: and
  rules:
    - op: is windows
    - op: contains
      path: event/COMMAND_LINE
      value: "reg add HKLM"
```

Available platform operators:
- `is windows`, `is linux`, `is mac`, `is chrome`
- `is 32 bit`, `is 64 bit`, `is arm`
- `is text`, `is json`
- `is gcp`, `is carbon_black`
- `is platform`: Custom platform matching

### Advanced Operations

#### `lookup` - External Resource Integration
Integrates with external lookup tables and threat intelligence.

```yaml
detect:
  op: lookup
  resource: "hive://lookup/malicious_ips"
  path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
  metadata_rules:
    op: contains
    path: tags
    value: "botnet"
```

#### `external` - External Detection Resources
Calls external detection logic.

```yaml
detect:
  op: external
  resource: "extension://virustotal"
  path: event/FILE_HASH
```

#### `has cve` - Vulnerability Detection
Checks for known CVEs in software products/versions.

```yaml
detect:
  op: has cve
  product: "microsoft"
  version_path: event/INSTALLED_VERSION
  product_path: event/PRODUCT_NAME
```

#### `is tagged` - Sensor Tag Checking
Checks if sensor has specific tags.

```yaml
detect:
  op: is tagged
  tag: "critical_server"
```

#### `cidr` - IP Range Matching
Matches IP addresses against CIDR ranges.

```yaml
detect:
  op: cidr
  path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
  cidr: "192.168.1.0/24"
```

#### `is public address` / `is private address` - IP Classification
Classifies IP addresses as public or private.

```yaml
detect:
  op: is public address
  path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
```

#### `is older than` - Age Comparison
Compares timestamps for age-based detection.

```yaml
detect:
  op: is older than
  path: event/TIMESTAMP
  seconds: 604800  # 7 days in seconds (7*24*60*60)
```

#### `yara` - Malware Detection (Artifact Target Only)
Applies YARA rules to artifact content.

```yaml
target: artifact
detect:
  op: yara
  resource: "hive://yara/malware_rules"
```

---

## Rule Structure & Configuration

### Global Parameters

These parameters apply to all rules regardless of operator:

#### `target` - Target Type Selection
Specifies the data source for the rule.

```yaml
target: edr        # Default, can be omitted
target: detection  # Process other detections
target: artifact   # Process collected artifacts
```

#### `comment` - Documentation
Describes the rule's purpose and logic.

```yaml
comment: "Detects PowerShell execution with encoded commands"
```

#### `debug` - Debug Mode
Enables detailed logging for rule troubleshooting.

```yaml
debug: true
```

#### `tests` - Rule Validation
Defines test cases to validate rule logic.

```yaml
tests:
  match:
    - - event:
          NEW_PROCESS:
            COMMAND_LINE: "powershell -encodedcommand ZQBjaABvACAAIgBoAGUAbABsAG8AIgA="
  not_match:
    - - event:
          NEW_PROCESS:
            COMMAND_LINE: "notepad.exe"
```

### Event Filtering

#### `event` / `events` - Event Type Filter
Restricts rule to specific event types for performance.

```yaml
# Single event type
event: NEW_PROCESS

# Multiple event types
events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  - TERMINATE_PROCESS
```

### Target-Specific Parameters

#### EDR Target Parameters
```yaml
target: edr
events:
  - NEW_PROCESS
  - FILE_CREATE
```

#### Artifact Target Parameters
```yaml
target: artifact
artifact source: "malware_analysis"  # Filter by source
artifact type: "file"                # Filter by type
artifact path: "*.exe"               # Filter by path pattern
```

#### Detection Target Parameters
```yaml
target: detection
# No additional parameters - processes all detections
```

### Stateful Detection Parameters

Enable complex multi-event correlation:

#### `with child` - Immediate Children
Matches events from immediate child processes.

```yaml
detect:
  op: contains
  path: event/COMMAND_LINE
  value: "powershell"
  with child:
    op: contains
    path: event/COMMAND_LINE
    value: "invoke-expression"
```

#### `with descendant` - Any Descendants
Matches events from any descendant process.

```yaml
detect:
  op: is
  path: event/FILE_PATH
  value: "explorer.exe"
  file name: true
  with descendant:
    op: contains
    path: event/COMMAND_LINE
    value: "mimikatz"
```

#### `with events` - Temporal Correlation
Correlates multiple events within a time window.

```yaml
detect:
  op: is
  path: event/NEW_PROCESS/IMAGE_FILE_PATH
  value: "powershell.exe"
  file name: true
  with events:
    op: contains
    path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
    value: "malicious_ip"
    count: 3      # At least 3 network connections
    within: 300   # Within 5 minutes
```

#### Stateful Parameters:
- `count`: Required number of matches (default: 1)
- `within`: Time window in seconds
- `report latest event`: Report final event instead of initial

### Time-Based Parameters

#### `times` - Time Restrictions
Restricts rule execution to specific time periods.

```yaml
times:
  # Business hours only
  - start: "09:00"
    end: "17:00"
    days: ["monday", "tuesday", "wednesday", "thursday", "friday"]
  
  # Exclude maintenance windows
  - start: "02:00"
    end: "04:00"
    days: ["sunday"]
    not: true
```

#### `is stateless` - Disable State Tracking
Prevents stateful tracking for performance optimization.

```yaml
is stateless: true
```

### Path & Value Modifiers

#### `path` - Data Extraction
JSONPath-style selectors for extracting data.

```yaml
path: event/NEW_PROCESS/COMMAND_LINE
path: routing/sid                    # Sensor ID
path: event/MODULES[0]/MODULE_PATH   # First module
```

#### `value` - Comparison Values
Supports static values and templates.

```yaml
value: "suspicious.exe"              # Static string
value: "{{.event.PARENT.FILE_PATH}}" # Template from event
value: "{{secret \"api_key\"}}"      # Secret reference
```

#### `file name` - Filename Extraction
Extracts filename from full path.

```yaml
detect:
  op: is
  path: event/FILE_PATH
  value: "malware.exe"
  file name: true  # Extracts filename from path
```

#### `sub domain` - Array Slicing
Array slice notation for extracting portions of arrays.

```yaml
detect:
  op: contains
  path: event/DNS_REQUEST/DOMAIN_NAME
  value: "evil.com"
  sub domain: "[1:]"  # Everything after first subdomain
```

#### `case sensitive` - Case Sensitivity
Controls case sensitivity for string operations.

```yaml
detect:
  op: contains
  path: event/COMMAND_LINE
  value: "POWERSHELL"
  case sensitive: false  # Will match "powershell", "PowerShell", etc.
```

#### `truthy` - Non-Empty Validation
Requires non-empty, non-null values.

```yaml
detect:
  op: exists
  path: event/USER_NAME
  truthy: true  # Must exist and be non-empty
```

---

## Response Actions

Response actions define what happens when a rule detects a match. Multiple actions can be chained together.

### Detection & Reporting

#### `report` - Generate Detection
Creates a detection with metadata and routing information.

```yaml
respond:
  - action: report
    name: "execution"        # Detection category (stored as 'cat' field)
    priority: 80             # Priority level (1-100)
    metadata:
      technique: "T1059.001"  # MITRE ATT&CK technique
      severity: "medium"
      analyst_notes: "Encoded PowerShell command detected"
      alert_name: "Suspicious PowerShell Execution"  # Actual detection title
      tags: "powershell,obfuscation"  # Tags as comma-separated string
      confidence: 85          # Confidence level in metadata
    transform:
      # Transform event data before reporting
      custom_severity: "HIGH"
      enriched_context: "{{ .routing.hostname }}"
```

**Parameters:**
- `name`: Detection category (becomes the 'cat' field in the detection)
- `priority`: Priority level (1-100)
- `metadata`: Key-value metadata (where you put alert name, tags, confidence, etc.)
- `transform`: Data transformation (singular, not 'transforms')

#### `output` - Data Routing
Marks events for routing to external systems.

```yaml
respond:
  - action: output
    name: "siem_feed"
```

### Sensor Management

#### `task` - Execute Sensor Commands
Sends commands to sensors for investigation or response.

```yaml
respond:
  - action: task
    command: "file_get"
    arguments:
      file: "{{.event.FILE_PATH}}"
      max_size: 10485760  # 10MB limit
```

**Common Commands:**
- `file_get`: Retrieve files
- `mem_map`: Memory analysis
- `os_kill_process`: Terminate processes
- `reg_get`: Registry queries
- `dir_list`: Directory listings

#### `add tag` / `remove tag` - Sensor Tagging
Manages sensor tags for organization and targeting.

```yaml
respond:
  - action: add tag
    tag: "compromised"
    ttl: 86400  # Tag expires in 24 hours
  
  - action: remove tag
    tag: "clean"
```

#### `add var` / `del var` - Sensor Variables
Manages sensor-specific variables for state tracking.

```yaml
respond:
  - action: add var
    name: "last_incident"
    value: "{{.routing.this}}"
    ttl: 604800  # 7 days
  
  - action: del var
    name: "temporary_flag"
```

#### `isolate network` / `rejoin network` - Network Control
Controls sensor network connectivity for containment.

```yaml
respond:
  - action: isolate network
    # Isolates sensor from network
  
  - action: rejoin network
    # Restores network connectivity
```

#### `seal` / `unseal` - Write Protection
Controls sensor's ability to modify system state.

```yaml
respond:
  - action: seal
    # Prevents sensor from making changes
  
  - action: unseal
    # Restores normal operation
```

#### `undelete sensor` - Sensor Recovery
Restores previously deleted sensors.

```yaml
respond:
  - action: undelete sensor
    # Recovers deleted sensor
```

#### `re-enroll` - Force Re-enrollment
Forces sensor to re-enroll with new configuration.

```yaml
respond:
  - action: re-enroll
    # Forces fresh enrollment
```

### External Integrations

#### `service request` - Internal Service Calls
Calls LimaCharlie internal services.

```yaml
respond:
  - action: service request
    service: "insight"
    action: "add_detection"
    data:
      detection_id: "{{.routing.this}}"
      priority: "high"
```

#### `extension request` - External Extensions
Calls external extensions and integrations.

```yaml
respond:
  - action: extension request
    extension name: "slack"
    extension action: "send_message"
    extension request:
      channel: "#security-alerts"
      message: "Critical detection: {{.detect.name}}"
```

#### `model request` - ML Model Updates
Updates machine learning models with detection data.

```yaml
respond:
  - action: model request
    model: "behavioral_analysis"
    action: "add_sample"
    data:
      features: "{{.event}}"
      label: "malicious"
```

### Utility Actions

#### `wait` - Introduce Delays
Adds delays between actions in response chains.

```yaml
respond:
  - action: report
    name: "Initial Detection"
  
  - action: wait
    duration: "30s"
  
  - action: task
    command: "mem_map"
```

#### `add hive tag` / `remove hive tag` - Hive-Level Tagging
Manages organization-level tags.

```yaml
respond:
  - action: add hive tag
    tag: "incident_active"
    ttl: 3600
  
  - action: remove hive tag
    tag: "all_clear"
```

---

## Advanced Features

### Stateful Detection

The D&R engine supports sophisticated stateful detection patterns that track relationships and correlations across multiple events.

#### Process Tree Tracking

Track relationships between parent and child processes:

```yaml
detect:
  # Parent process
  op: contains
  path: event/NEW_PROCESS/COMMAND_LINE
  value: "explorer.exe"
  
  # Immediate children
  with child:
    op: and
    rules:
      - op: contains
        path: event/NEW_PROCESS/COMMAND_LINE
        value: "powershell"
      - op: contains
        path: event/NEW_PROCESS/COMMAND_LINE
        value: "-windowstyle hidden"
```

```yaml
detect:
  # Initial process
  op: is
  path: event/NEW_PROCESS/FILE_PATH
  value: "winword.exe"
  file name: true
  
  # Any descendant processes
  with descendant:
    op: or
    rules:
      - op: contains
        path: event/NEW_PROCESS/COMMAND_LINE
        value: "powershell"
      - op: contains
        path: event/NEW_PROCESS/COMMAND_LINE
        value: "cmd.exe"
```

#### Temporal Correlation

Correlate events across time windows:

```yaml
detect:
  # Initial suspicious file creation
  op: and
  rules:
    - op: is
      path: event/FILE_CREATE/FILE_PATH
      value: ".bat"
      ends with: true
    - op: contains
      path: event/FILE_CREATE/FILE_PATH
      value: "\\Temp\\"
  
  # Network activity within 60 seconds
  with events:
    op: is public address
    path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
    count: 1
    within: 60
    report latest event: true
```

#### Complex Stateful Patterns

Nested stateful rules for advanced correlation:

```yaml
detect:
  # Office application starts
  op: or
  rules:
    - op: is
      path: event/NEW_PROCESS/FILE_PATH
      value: "winword.exe"
      file name: true
    - op: is
      path: event/NEW_PROCESS/FILE_PATH
      value: "excel.exe"
      file name: true
    - op: is
      path: event/NEW_PROCESS/FILE_PATH
      value: "powerpnt.exe"
      file name: true
  
  # Child process spawns
  with child:
    op: or
    rules:
      - op: contains
        path: event/NEW_PROCESS/COMMAND_LINE
        value: "powershell"
      - op: contains
        path: event/NEW_PROCESS/COMMAND_LINE
        value: "wscript"
    
    # Network activity from child process
    with events:
      op: and
      rules:
        - op: is public address
          path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
        - op: is
          path: event/NETWORK_ACTIVITY/DESTINATION/PORT
          value: 443
      count: 3
      within: 120
```

### Suppression System

Advanced suppression prevents alert fatigue while maintaining security coverage:

```yaml
respond:
  - action: report
    name: "Repeated Suspicious Activity"
    suppression:
      keys:
        - "{{.routing.sid}}"           # Per-sensor
        - "{{.event.PROCESS_ID}}"      # Per-process
        - "{{.event.USER_NAME}}"       # Per-user
      max_count: 5                     # Maximum 5 alerts
      period: "1h"                     # Per hour
      is_global: false                 # Organization-level
      count_path: "custom/count/path"  # Custom counter location
```

**Suppression Parameters:**
- `keys`: Array of suppression keys (supports templates) - **REQUIRED**
- `max_count`: Maximum alerts before suppression - **At least one of max_count or min_count required**
- `min_count`: Minimum alerts required for suppression
- `period`: Time window (e.g., "1h", "30m", "1d") - **REQUIRED** (1 second to 30 days)
- `is_global`: Organization-wide vs. sensor-specific (default: false)
- `count_path`: Custom path for counter storage (optional)

### Template System

The template system enables dynamic content generation using Go template syntax:

#### Basic Templates
```yaml
respond:
  - action: report
    name: "Process {{.event.NEW_PROCESS.FILE_PATH}} executed by {{.event.NEW_PROCESS.USER_NAME}}"
    metadata:
      sensor_id: "{{.routing.sid}}"
      timestamp: "{{.event.TIMESTAMP}}"
      process_id: "{{.event.NEW_PROCESS.PROCESS_ID}}"
```

#### Conditional Logic
```yaml
respond:
  - action: report
    name: "{{if eq .event.NEW_PROCESS.USER_NAME \"SYSTEM\"}}System Process{{else}}User Process{{end}} Detected"
    priority: "{{if eq .event.NEW_PROCESS.USER_NAME \"SYSTEM\"}}60{{else}}80{{end}}"
```

#### Secret Access
```yaml
respond:
  - action: extension request
    extension name: "webhook"
    extension action: "send_alert"
    extension request:
      url: "https://api.external.com/alert"
      headers:
        Authorization: "Bearer {{secret \"api_token\"}}"
      payload:
        alert: "{{.detect.name}}"
        sensor: "{{.routing.sid}}"
```

#### Variable References
```yaml
respond:
  - action: report
    metadata:
      previous_incident: "{{var \"last_incident_id\"}}"
      sensor_location: "{{var \"datacenter\"}}"
```

#### Transform Modifiers
The transform system supports built-in modifiers for data processing:

```yaml
respond:
  - action: report
    name: "data_processing"
    transform:
      # Parse JSON strings
      parsed_config: "event.raw_config|@parsejson"
      
      # Extract data with regex (named groups)
      extracted_ip: "event.log_line|@extract:{\"re\":\"IP: (?P<ip>\\\\d+\\\\.\\\\d+\\\\.\\\\d+\\\\.\\\\d+)\"}"
      
      # Parse timestamps
      formatted_time: "event.timestamp|@parsetime:{\"from\":\"epoch_ms\",\"to\":\"2006-01-02T15:04:05Z07:00\"}"
      epoch_time: "event.time_string|@parsetime:{\"from\":\"2006-01-02 15:04:05\",\"to\":\"epoch_s\"}"
      
      # Go template (separate field - cannot mix with modifiers)
      processed_data: "Parsed at {{ .event.formatted_timestamp }}"
```

**Available Modifiers:**
- `@parsejson`: Parse JSON string into object
- `@extract`: Regex extraction with named capture groups (requires JSON parameters)
- `@parsetime`: Convert between time formats (supports `epoch_s`, `epoch_ms`, custom formats)

**Important Notes:**
- All modifiers require `@` prefix (e.g., `|@parsejson`, not `|parsejson`)
- Parameters must be valid JSON in `{}` format
- Cannot combine Go templates with modifiers in the same field
- Use gjson path syntax (dot notation) for field references

### Resource Integration

#### Lookup Resources
Integrate external threat intelligence and reference data:

```yaml
detect:
  op: lookup
  resource: "hive://lookup/threat_intel"
  path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
  metadata_rules:
    # Additional filtering on lookup metadata
    op: and
    rules:
      - op: contains
        path: tags
        value: "malware"
      - op: is greater than
        path: confidence
        value: 80
```

#### Detection Resources
External detection logic integration:

```yaml
detect:
  op: external
  resource: "extension://custom_ml_model"
  path: event
  parameters:
    model_name: "behavioral_analysis"
    threshold: 0.8
```

#### YARA Resources (Artifact Target)
Malware detection using YARA rules:

```yaml
target: artifact
artifact type: "file"
detect:
  op: yara
  resource: "hive://yara/malware_families"
  metadata:
    # Filter YARA rule matches
    op: contains
    path: rule_name
    value: "trojan"
```

### Performance Optimization

#### Efficient Event Filtering
Use specific event types to reduce processing overhead:

```yaml
# Good - Specific event filtering
events:
  - NEW_PROCESS
  - EXISTING_PROCESS

# Avoid - Processing all events
# (no event filter)
```

#### Path Optimization
Use efficient path extraction:

```yaml
# Good - Direct path access
path: event/NEW_PROCESS/COMMAND_LINE

# Inefficient - Complex nested access
path: event/NEW_PROCESS/MODULES[*]/SIGNATURES[*]/ISSUER
```

#### Stateless Rules
Use stateless rules when correlation isn't needed:

```yaml
# Stateless for simple detection
is stateless: true
detect:
  op: contains
  path: event/FILE_PATH
  value: "malware.exe"
```

#### Resource Caching
Leverage automatic caching for repeated operations:

```yaml
# Lookups are automatically cached
detect:
  op: lookup
  resource: "hive://lookup/malicious_domains"
  path: event/DNS_REQUEST/DOMAIN_NAME
```

---

## Cybersecurity Examples by Target Type

This section provides comprehensive real-world cybersecurity examples for each target type, demonstrating practical D&R rule implementation.

### EDR Target Examples

EDR rules process real-time telemetry from endpoints, making them ideal for threat detection and behavioral analysis.

#### Example 1: Living-off-the-Land Attack Detection

```yaml
# Detects suspicious use of legitimate Windows utilities
target: edr
events:
  - NEW_PROCESS

detect:
  op: and
  rules:
    # Windows platform only
    - op: is windows
    
    # Legitimate Windows utilities
    - op: or
      rules:
        - op: is
          path: event/NEW_PROCESS/FILE_PATH
          value: "certutil.exe"
          file name: true
        - op: is
          path: event/NEW_PROCESS/FILE_PATH
          value: "bitsadmin.exe"
          file name: true
        - op: is
          path: event/NEW_PROCESS/FILE_PATH
          value: "wmic.exe"
          file name: true
    
    # Suspicious command line patterns
    - op: or
      rules:
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "-urlcache"
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "/transfer"
        - op: matches
          path: event/NEW_PROCESS/COMMAND_LINE
          re: "http[s]?://[^\\s]+"

respond:
  - action: report
    name: "execution"
    priority: 85
    metadata:
      technique: "T1105"  # Ingress Tool Transfer
      utility: "{{.event.NEW_PROCESS.FILE_PATH}}"
      command_line: "{{.event.NEW_PROCESS.COMMAND_LINE}}"
      alert_name: "Living-off-the-Land Binary Abuse"
      confidence: 90
      tags: "lolbin,suspicious_utility,potential_download"

comment: "Detects abuse of legitimate Windows utilities for malicious purposes"
```

#### Example 2: Process Injection Detection with Stateful Correlation

```yaml
# Detects process injection techniques using stateful detection
target: edr
events:
  - NEW_PROCESS
  - SENSITIVE_PROCESS_ACCESS
  - REMOTE_THREAD_DETECTED

detect:
  # Initial suspicious process
  op: and
  rules:
    - op: or
      rules:
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "powershell"
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "rundll32"
        - op: contains
          path: event/NEW_PROCESS/FILE_PATH
          value: "\\Temp\\"
    
    # Not a known legitimate process
    - op: or
      not: true
      rules:
        - op: contains
          path: event/NEW_PROCESS/FILE_PATH
          value: "\\System32\\"
        - op: contains
          path: event/NEW_PROCESS/FILE_PATH
          value: "\\SysWOW64\\"
  
  # Correlate with process access events
  with events:
    op: or
    rules:
      - op: is
        path: event/SENSITIVE_PROCESS_ACCESS/TARGET_PROCESS_NAME
        value: "explorer.exe"
      - op: is
        path: event/SENSITIVE_PROCESS_ACCESS/TARGET_PROCESS_NAME
        value: "winlogon.exe"
      - op: contains
        path: event/SENSITIVE_PROCESS_ACCESS/ACCESS_TYPE
        value: "PROCESS_VM_WRITE"
    count: 1
    within: 30

respond:
  - action: report
    name: "defense_evasion"
    priority: 95
    metadata:
      technique: "T1055"
      injector_process: "{{.event.NEW_PROCESS.FILE_PATH}}"
      target_process: "{{.event.SENSITIVE_PROCESS_ACCESS.TARGET_PROCESS_NAME}}"
      alert_name: "Process Injection Detected"
      confidence: 85
      tags: "process_injection,memory_manipulation,evasion"
  
  - action: task
    command: "mem_map"
    arguments:
      pid: "{{.event.NEW_PROCESS.PROCESS_ID}}"
  
  - action: add tag
    tag: "process_injection_detected"
    ttl: 3600

comment: "Detects various process injection techniques using behavioral correlation"
```

#### Example 3: Credential Harvesting Detection

```yaml
# Detects credential harvesting tools and techniques
target: edr
events:
  - NEW_PROCESS
  - FILE_CREATE
  - REGISTRY_ACTIVITY

detect:
  op: or
  rules:
    # Known credential harvesting tools
    - op: or
      rules:
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "mimikatz"
          case sensitive: false
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "sekurlsa"
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "procdump"
        - op: and
          rules:
            - op: contains
              path: event/NEW_PROCESS/COMMAND_LINE
              value: "lsass"
            - op: contains
              path: event/NEW_PROCESS/COMMAND_LINE
              value: "dump"
    
    # SAM/SYSTEM file access
    - op: and
      rules:
        - op: is
          path: event/FILE_CREATE/EVENT_TYPE
          value: "FILE_CREATE"
        - op: or
          rules:
            - op: contains
              path: event/FILE_CREATE/FILE_PATH
              value: "\\sam"
              case sensitive: false
            - op: contains
              path: event/FILE_CREATE/FILE_PATH
              value: "\\system"
              case sensitive: false
            - op: contains
              path: event/FILE_CREATE/FILE_PATH
              value: "\\security"
              case sensitive: false
    
    # Registry credential access
    - op: and
      rules:
        - op: is
          path: event/REGISTRY_ACTIVITY/EVENT_TYPE
          value: "REGISTRY_ACTIVITY"
        - op: or
          rules:
            - op: contains
              path: event/REGISTRY_ACTIVITY/REGISTRY_PATH
              value: "SAM\\SAM\\Domains\\Account\\Users"
            - op: contains
              path: event/REGISTRY_ACTIVITY/REGISTRY_PATH
              value: "SECURITY\\Policy\\Secrets"

respond:
  - action: report
    name: "credential_access"
    priority: 95
    metadata:
      technique: "T1003"
      method: "{{if .event.NEW_PROCESS}}process{{else if .event.FILE_CREATE}}file{{else}}registry{{end}}"
      details: "{{if .event.NEW_PROCESS}}{{.event.NEW_PROCESS.COMMAND_LINE}}{{else if .event.FILE_CREATE}}{{.event.FILE_CREATE.FILE_PATH}}{{else}}{{.event.REGISTRY_ACTIVITY.REGISTRY_PATH}}{{end}}"
      alert_name: "Credential Harvesting Activity"
      confidence: 90
      tags: "credential_theft,lsass_access,registry_access"
  
  - action: isolate network
  
  - action: task
    command: "mem_map"
    arguments:
      pid: "{{.event.NEW_PROCESS.PROCESS_ID}}"

comment: "Detects various credential harvesting techniques including mimikatz, SAM dumping, and registry access"
```

#### Example 4: Lateral Movement Detection

```yaml
# Detects lateral movement using Windows services and scheduled tasks
target: edr
events:
  - NEW_PROCESS
  - NETWORK_ACTIVITY

detect:
  op: and
  rules:
    # Service or task creation utilities
    - op: or
      rules:
        - op: and
          rules:
            - op: is
              path: event/NEW_PROCESS/FILE_PATH
              value: "sc.exe"
              file name: true
            - op: or
              rules:
                - op: contains
                  path: event/NEW_PROCESS/COMMAND_LINE
                  value: "create"
                - op: contains
                  path: event/NEW_PROCESS/COMMAND_LINE
                  value: "start"
        - op: and
          rules:
            - op: is
              path: event/NEW_PROCESS/FILE_PATH
              value: "schtasks.exe"
              file name: true
            - op: contains
              path: event/NEW_PROCESS/COMMAND_LINE
              value: "/create"
        - op: and
          rules:
            - op: is
              path: event/NEW_PROCESS/FILE_PATH
              value: "wmic.exe"
              file name: true
            - op: contains
              path: event/NEW_PROCESS/COMMAND_LINE
              value: "process call create"
    
    # Remote target in command line
    - op: or
      rules:
        - op: matches
          path: event/NEW_PROCESS/COMMAND_LINE
          re: "\\\\\\\\[^\\s]+\\\\"  # UNC path
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "/s "  # Remote system parameter
        - op: contains
          path: event/NEW_PROCESS/COMMAND_LINE
          value: "/node:"
  
  # Network activity to confirm lateral movement
  with events:
    op: and
    rules:
      - op: is private address
        path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
      - op: or
        rules:
          - op: is
            path: event/NETWORK_ACTIVITY/DESTINATION/PORT
            value: 135  # RPC
          - op: is
            path: event/NETWORK_ACTIVITY/DESTINATION/PORT
            value: 445  # SMB
          - op: is
            path: event/NETWORK_ACTIVITY/DESTINATION/PORT
            value: 5985 # WinRM
    count: 1
    within: 60

respond:
  - action: report
    name: "lateral_movement"
    priority: 90
    metadata:
      technique: "T1021"
      tool: "{{.event.NEW_PROCESS.FILE_PATH}}"
      target_ip: "{{.event.NETWORK_ACTIVITY.DESTINATION.IP_ADDRESS}}"
      target_port: "{{.event.NETWORK_ACTIVITY.DESTINATION.PORT}}"
      alert_name: "Lateral Movement Attempt"
      confidence: 85
      tags: "lateral_movement,remote_execution,network_propagation"
  
  - action: add tag
    tag: "lateral_movement_source"
    ttl: 3600

comment: "Detects lateral movement attempts using Windows administrative tools"
```

### Detection Target Examples

Detection rules process alerts generated by other D&R rules, enabling alert correlation, escalation, and suppression.

#### Example 5: Multi-Stage Attack Correlation

```yaml
# Correlates multiple detections to identify coordinated attacks
target: detection

detect:
  op: and
  rules:
    # Multiple detection categories from same sensor
    - op: or
      rules:
        - op: is
          path: event/detect/cat
          value: "execution"
        - op: is
          path: event/detect/cat
          value: "persistence"
        - op: is
          path: event/detect/cat
          value: "credential_access"
        - op: is
          path: event/detect/cat
          value: "lateral_movement"
    
    # Time window for correlation
    - op: is older than
      path: event/ts
      seconds: 900
      not: true  # Within last 15 minutes (900 seconds)

respond:
  - action: report
    name: "impact"
    priority: 95
    metadata:
      technique: "TA0001-TA0040"  # Multiple tactics
      attack_stages: "{{.detect.cat}}"
      timeline: "15_minutes"
      escalation_reason: "Multiple attack stages detected"
      alert_name: "Multi-Stage Attack Pattern"
      confidence: 95
      tags: "apt,coordinated_attack,kill_chain"
    suppression:
      keys:
        - "{{.routing.sid}}"
        - "multi_stage_attack"
      max_count: 1
      period: "1h"
  
  - action: add tag
    tag: "coordinated_attack"
    ttl: 7200
  
  - action: extension request
    extension name: "incident_response"
    extension action: "create_incident"
    extension request:
      severity: "critical"
      sensor_id: "{{.routing.sid}}"
      detection_ids: "{{.routing.this}}"

comment: "Escalates incidents when multiple attack stages are detected on the same sensor"
```

#### Example 6: False Positive Suppression

```yaml
# Suppresses common false positives based on context
target: detection

detect:
  op: and
  rules:
    # Specific detection types prone to false positives
    - op: or
      rules:
        - op: contains
          path: event/detect/name
          value: "Suspicious Process"
        - op: contains
          path: event/detect/name
          value: "Network Anomaly"
    
    # Legitimate business context
    - op: or
      rules:
        # Tagged as development/test system
        - op: is tagged
          tag: "development"
        
        # Known administrative users
        - op: or
          rules:
            - op: is
              path: event/USER_NAME
              value: "admin"
            - op: is
              path: event/USER_NAME
              value: "service_account"
            - op: is
              path: event/USER_NAME
              value: "backup_user"

    # Low confidence detections
    - op: is lower than
      path: event/detect/confidence
      value: 70

times:
  # During business hours
  - start: "09:00"
    end: "17:00"
    days: ["monday", "tuesday", "wednesday", "thursday", "friday"]

respond:
  - action: report
    name: "suppression"
    priority: 10
    metadata:
      original_detection: "{{.event.detect.name}}"
      suppression_reason: "Business context indicates legitimate activity"
      confidence: "{{.event.detect.confidence}}"
      alert_name: "False Positive Suppression"
      tags: "false_positive,suppressed"

comment: "Suppresses likely false positives based on business context and detection confidence"
```

### Deployment Target Examples

Deployment rules monitor sensor lifecycle events, useful for operational monitoring and security validation.

#### Example 7: Unauthorized Sensor Deployment Detection

```yaml
# Detects sensors deployed from unauthorized locations or configurations
target: deployment

detect:
  op: and
  event: sensor_enrolled
  rules:
    # Sensor not from approved installation keys
    - op: contains
      path: event/iid
      value: "approved_deployment_"
      not: true
    
    # Unexpected geographic location
    - op: lookup
      resource: "hive://lookup/geoip"
      path: event/sensor_info/external_ip
      metadata_rules:
        op: or
        rules:
          - op: contains
            path: country
            value: "CN"  # China
          - op: contains
            path: country
            value: "RU"  # Russia
          - op: contains
            path: country
            value: "KP"  # North Korea
    
    # Production organization
    - op: is tagged
      tag: "production"

respond:
  - action: report
    name: "initial_access"  # This becomes the detection category
    priority: 95
    metadata:
      technique: "T1078"
      sensor_ip: "{{.event.sensor_info.external_ip}}"
      country: "{{.geoip.country}}"
      installation_key: "{{.event.iid}}"
      alert_name: "Unauthorized Sensor Deployment"
      tags: "unauthorized_deployment,rogue_sensor,geographic_anomaly"
      confidence: 90
  
  - action: task
    command: "sensor_delete"
    arguments:
      reason: "Unauthorized deployment detected"

comment: "Detects and removes sensors deployed from unauthorized locations"
```

#### Example 8: Sensor Health Monitoring

```yaml
# Monitors sensor deployment health and configuration drift
target: deployment

detect:
  op: or
  events:
    - sensor_enrolled
    - sensor_updated
    - sensor_deleted
  rules:
    # Rapid sensor turnover (potential compromise)
    - op: and
      rules:
        - op: is
          path: event/event_type
          value: "sensor_deleted"
      
      with events:
        op: is
        path: event/event_type
        value: "sensor_enrolled"
        count: 3
        within: 300  # 5 minutes
    
    # Configuration drift
    - op: and
      rules:
        - op: is
          path: event/event_type
          value: "sensor_updated"
        - op: contains
          path: event/configuration_changes
          value: "critical_setting"
    
    # Sensor from unexpected subnet
    - op: and
      rules:
        - op: is
          path: event/event_type
          value: "sensor_enrolled"
        - op: is private address
          path: event/sensor_info/internal_ip
        - op: cidr
          path: event/sensor_info/internal_ip
          value: "10.0.0.0/8"
          not: true  # Not in expected corporate network

respond:
  - action: report
    name: "operational"
    priority: 70
    metadata:
      event_type: "{{.event.event_type}}"
      sensor_ip: "{{.event.sensor_info.internal_ip}}"
      anomaly_type: "{{if eq .event.event_type \"sensor_deleted\"}}rapid_turnover{{else if eq .event.event_type \"sensor_updated\"}}config_drift{{else}}network_anomaly{{end}}"
      alert_name: "Sensor Deployment Anomaly"
      tags: "deployment_monitoring,operational_security"

comment: "Monitors sensor deployment patterns for operational and security anomalies"
```

### Artifact Target Examples

Artifact rules analyze collected files, memory dumps, and other forensic evidence.

#### Example 9: Malware Analysis with YARA

```yaml
# Analyzes uploaded files for malware signatures
target: artifact
artifact type: "file"
artifact source: "malware_analysis"

detect:
  op: and
  rules:
    # YARA rule matches
    - op: yara
      resource: "hive://yara/malware_families"
      metadata:
        op: and
        rules:
          - op: contains
            path: rule_name
            value: "trojan"
          - op: is greater than
            path: score
            value: 80
    
    # File characteristics
    - op: or
      rules:
        - op: ends with
          path: artifact_path
          value: ".exe"
          case sensitive: false
        - op: ends with
          path: artifact_path
          value: ".dll"
          case sensitive: false
        - op: ends with
          path: artifact_path
          value: ".scr"
          case sensitive: false

respond:
  - action: report
    name: "malware"
    priority: 95
    metadata:
      technique: "T1204"
      file_path: "{{.artifact_path}}"
      yara_rules: "{{.yara.rule_name}}"
      family: "{{.yara.family}}"
      hash: "{{.artifact_hash}}"
      alert_name: "Malware Detected in Artifact"
      confidence: 95
      tags: "malware,file_analysis,yara_detection"
  
  - action: add hive tag
    tag: "malware_detected"
    ttl: 86400
  
  - action: extension request
    extension name: "threat_intel"
    extension action: "add_ioc"
    extension request:
      type: "file_hash"
      value: "{{.artifact_hash}}"
      confidence: 95

comment: "Analyzes uploaded files with YARA rules for malware detection"
```

#### Example 10: Sensitive Data Exposure Detection

```yaml
# Detects sensitive data in collected artifacts
target: artifact
artifact type: "file"

detect:
  op: and
  rules:
    # Text-based files
    - op: or
      rules:
        - op: ends with
          path: artifact_path
          value: ".txt"
          case sensitive: false
        - op: ends with
          path: artifact_path
          value: ".log"
          case sensitive: false
        - op: ends with
          path: artifact_path
          value: ".csv"
          case sensitive: false
        - op: ends with
          path: artifact_path
          value: ".sql"
          case sensitive: false
    
    # Sensitive data patterns
    - op: or
      rules:
        # Credit card numbers
        - op: matches
          path: artifact_content
          re: "\\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|3[0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})\\b"
        
        # Social Security Numbers
        - op: matches
          path: artifact_content
          re: "\\b\\d{3}-\\d{2}-\\d{4}\\b"
        
        # API keys/tokens
        - op: matches
          path: artifact_content
          re: "(?i)(api[_-]?key|token|secret)[\\s]*[=:][\\s]*['\"]?[a-z0-9]{20,}['\"]?"
        
        # Email addresses in bulk
        - op: matches
          path: artifact_content
          re: "([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}[\\s,;]*){10,}"

respond:
  - action: report
    name: "data_exfiltration"
    priority: 90
    metadata:
      technique: "T1005"
      file_path: "{{.artifact_path}}"
      data_type: "{{if contains .artifact_content \"4[0-9]{12}\"}}credit_card{{else if contains .artifact_content \"-\"}}ssn{{else if contains .artifact_content \"api\"}}credentials{{else}}email_list{{end}}"
      severity: "high"
      alert_name: "Sensitive Data Exposure"
      confidence: 85
      tags: "data_exposure,pii,compliance_violation"
  
  - action: task
    command: "file_delete"
    arguments:
      file: "{{.artifact_path}}"
      reason: "Sensitive data exposure"

comment: "Detects various types of sensitive data in collected artifacts"
```

### Artifact Event Target Examples

Artifact event rules monitor the lifecycle of artifact processing.

#### Example 11: Artifact Processing Monitoring

```yaml
# Monitors artifact processing pipeline for failures and anomalies
target: artifact_event
events:
  - artifact_ingested
  - processing_complete
  - processing_failed

detect:
  op: or
  rules:
    # Processing failures
    - op: and
      rules:
        - op: is
          path: event/event_type
          value: "processing_failed"
        - op: contains
          path: event/error_message
          value: "timeout"
          not: true  # Not simple timeouts
    
    # Large artifacts
    - op: and
      rules:
        - op: is
          path: event/event_type
          value: "artifact_ingested"
        - op: is greater than
          path: event/artifact_size
          value: 104857600  # 100MB
    
    # Suspicious artifact sources
    - op: and
      rules:
        - op: is
          path: event/event_type
          value: "artifact_ingested"
        - op: or
          rules:
            - op: contains
              path: event/artifact_source
              value: "external"
            - op: contains
              path: event/artifact_source
              value: "unknown"

respond:
  - action: report
    name: "operational"
    priority: "{{if eq .event.event_type \"processing_failed\"}}80{{else if gt .event.artifact_size 104857600}}60{{else}}40{{end}}"
    metadata:
      alert_name: "Artifact Processing Event"
      event_type: "{{.event.event_type}}"
      artifact_id: "{{.event.artifact_id}}"
      source: "{{.event.artifact_source}}"
      size: "{{.event.artifact_size}}"
      processing_time: "{{.event.processing_duration}}"
      tags: "artifact_monitoring,processing_pipeline"

comment: "Monitors artifact processing pipeline for operational awareness"
```

---

## Complex Multi-Stage Rules

This section demonstrates sophisticated D&R rules that combine multiple features for advanced threat detection.

### Example 12: Advanced Persistent Threat (APT) Detection Chain

```yaml
# Comprehensive APT detection using multiple correlation techniques
target: edr
events:
  - NEW_PROCESS
  - FILE_CREATE
  - NETWORK_ACTIVITY
  - REGISTRY_ACTIVITY

detect:
  # Initial compromise vector
  op: and
  rules:
    # Office application with suspicious child
    - op: or
      path: event/NEW_PROCESS/PARENT/FILE_PATH
      rules:
        - value: "winword.exe"
          file name: true
        - value: "excel.exe"
          file name: true
        - value: "powerpnt.exe"
          file name: true
    
    # Suspicious child process
    - op: or
      rules:
        - op: and
          rules:
            - op: is
              path: event/NEW_PROCESS/FILE_PATH
              value: "powershell.exe"
              file name: true
            - op: or
              rules:
                - op: contains
                  path: event/NEW_PROCESS/COMMAND_LINE
                  value: "-encodedcommand"
                - op: contains
                  path: event/NEW_PROCESS/COMMAND_LINE
                  value: "-windowstyle hidden"
                - op: contains
                  path: event/NEW_PROCESS/COMMAND_LINE
                  value: "invoke-expression"
        
        - op: and
          rules:
            - op: is
              path: event/NEW_PROCESS/FILE_PATH
              value: "wscript.exe"
              file name: true
            - op: contains
              path: event/NEW_PROCESS/COMMAND_LINE
              value: ".vbs"
  
  # Persistence establishment
  with descendant:
    op: or
    rules:
      # Registry persistence
      - op: and
        rules:
          - op: is
            path: event/REGISTRY_ACTIVITY/EVENT_TYPE
            value: "REGISTRY_ACTIVITY"
          - op: or
            rules:
              - op: contains
                path: event/REGISTRY_ACTIVITY/REGISTRY_PATH
                value: "CurrentVersion\\Run"
              - op: contains
                path: event/REGISTRY_ACTIVITY/REGISTRY_PATH
                value: "CurrentVersion\\RunOnce"
              - op: contains
                path: event/REGISTRY_ACTIVITY/REGISTRY_PATH
                value: "CurrentVersion\\Windows\\Load"
      
      # Scheduled task persistence
      - op: and
        rules:
          - op: is
            path: event/NEW_PROCESS/FILE_PATH
            value: "schtasks.exe"
            file name: true
          - op: contains
            path: event/NEW_PROCESS/COMMAND_LINE
            value: "/create"
      
      # Service persistence
      - op: and
        rules:
          - op: is
            path: event/NEW_PROCESS/FILE_PATH
            value: "sc.exe"
            file name: true
          - op: contains
            path: event/NEW_PROCESS/COMMAND_LINE
            value: "create"
  
  # Command and control communication
  with events:
    op: and
    rules:
      - op: is
        path: event/NETWORK_ACTIVITY/EVENT_TYPE
        value: "NETWORK_ACTIVITY"
      - op: is public address
        path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
      - op: or
        rules:
          # Common C2 ports
          - op: is
            path: event/NETWORK_ACTIVITY/DESTINATION/PORT
            value: 443
          - op: is
            path: event/NETWORK_ACTIVITY/DESTINATION/PORT
            value: 80
          - op: is
            path: event/NETWORK_ACTIVITY/DESTINATION/PORT
            value: 8080
          - op: is
            path: event/NETWORK_ACTIVITY/DESTINATION/PORT
            value: 53
      # Threat intel lookup
      - op: lookup
        resource: "hive://lookup/apt_infrastructure"
        path: event/NETWORK_ACTIVITY/DESTINATION/IP_ADDRESS
        metadata_rules:
          op: is greater than
          path: confidence
          value: 70
    count: 3
    within: 1800  # 30 minutes

respond:
  - action: report
    name: "apt"
    priority: 98
    metadata:
      alert_name: "Advanced Persistent Threat Activity"
      technique: "TA0001,TA0003,TA0011"  # Initial Access, Persistence, C2
      initial_vector: "{{.event.NEW_PROCESS.PARENT.FILE_PATH}}"
      persistence_method: "{{if .events.REGISTRY_ACTIVITY}}registry{{else if contains .events.NEW_PROCESS.COMMAND_LINE \"schtasks\"}}scheduled_task{{else}}service{{end}}"
      c2_ip: "{{.events.NETWORK_ACTIVITY.DESTINATION.IP_ADDRESS}}"
      timeline: "30_minutes"
      confidence: 95
      tags: "apt,full_kill_chain,persistent_threat,c2_communication"
    suppression:
      keys:
        - "{{.routing.sid}}"
        - "apt_campaign"
      max_count: 1
      period: "24h"
  
  - action: isolate network
  
  - action: add tag
    tag: "apt_victim"
    ttl: 86400
  
  - action: extension request
    extension name: "incident_response"
    extension action: "create_major_incident"
    extension request:
      severity: "critical"
      category: "apt"
      evidence:
        sensor_id: "{{.routing.sid}}"
        initial_process: "{{.event.NEW_PROCESS.COMMAND_LINE}}"
        c2_infrastructure: "{{.events.NETWORK_ACTIVITY.DESTINATION.IP_ADDRESS}}"
  
  - action: task
    command: "mem_map"
    arguments:
      pid: "{{.event.NEW_PROCESS.PROCESS_ID}}"
  
  - action: task
    command: "file_get"
    arguments:
      file: "{{.event.NEW_PROCESS.FILE_PATH}}"

comment: "Comprehensive APT detection covering initial access, persistence, and C2 communication"
```

### Example 13: Ransomware Behavior Detection

```yaml
# Multi-stage ransomware detection with prevention capabilities
target: edr
events:
  - NEW_PROCESS
  - FILE_CREATE
  - FILE_DELETE
  - REGISTRY_ACTIVITY

detect:
  # Suspicious process with file system activity
  op: and
  rules:
    # Process characteristics
    - op: or
      rules:
        # Unsigned executable
        - op: not
          op: exists
          path: event/NEW_PROCESS/SIGNATURE/ISSUER
        
        # Suspicious location
        - op: or
          rules:
            - op: contains
              path: event/NEW_PROCESS/FILE_PATH
              value: "\\Temp\\"
            - op: contains
              path: event/NEW_PROCESS/FILE_PATH
              value: "\\Downloads\\"
            - op: contains
              path: event/NEW_PROCESS/FILE_PATH
              value: "\\AppData\\Local\\"
        
        # Suspicious name patterns
        - op: matches
          path: event/NEW_PROCESS/FILE_PATH
          re: "(?i)(crypt|lock|encrypt|ransom|restore)"
          file name: true
    
    # Not whitelisted process
    - op: not
      op: lookup
      resource: "hive://lookup/approved_executables"
      path: event/NEW_PROCESS/FILE_HASH
  
  # Mass file operations
  with events:
    op: and
    rules:
      # File extensions commonly targeted by ransomware
      - op: or
        rules:
          # Document files
          - op: or
            rules:
              - op: and
                rules:
                  - op: is
                    path: event/FILE_CREATE/EVENT_TYPE
                    value: "FILE_CREATE"
                  - op: matches
                    path: event/FILE_CREATE/FILE_PATH
                    re: "\\.(doc|docx|xls|xlsx|ppt|pptx|pdf|txt)$"
                    case sensitive: false
              - op: and
                rules:
                  - op: is
                    path: event/FILE_DELETE/EVENT_TYPE
                    value: "FILE_DELETE"
                  - op: matches
                    path: event/FILE_DELETE/FILE_PATH
                    re: "\\.(doc|docx|xls|xlsx|ppt|pptx|pdf|txt)$"
                    case sensitive: false
          
          # Image files
          - op: or
            rules:
              - op: and
                rules:
                  - op: is
                    path: event/FILE_CREATE/EVENT_TYPE
                    value: "FILE_CREATE"
                  - op: matches
                    path: event/FILE_CREATE/FILE_PATH
                    re: "\\.(jpg|jpeg|png|gif|bmp|tiff)$"
                    case sensitive: false
              - op: and
                rules:
                  - op: is
                    path: event/FILE_DELETE/EVENT_TYPE
                    value: "FILE_DELETE"
                  - op: matches
                    path: event/FILE_DELETE/FILE_PATH
                    re: "\\.(jpg|jpeg|png|gif|bmp|tiff)$"
                    case sensitive: false
          
          # Database files
          - op: or
            rules:
              - op: and
                rules:
                  - op: is
                    path: event/FILE_CREATE/EVENT_TYPE
                    value: "FILE_CREATE"
                  - op: matches
                    path: event/FILE_CREATE/FILE_PATH
                    re: "\\.(mdb|accdb|sql|db|dbf)$"
                    case sensitive: false
              - op: and
                rules:
                  - op: is
                    path: event/FILE_DELETE/EVENT_TYPE
                    value: "FILE_DELETE"
                  - op: matches
                    path: event/FILE_DELETE/FILE_PATH
                    re: "\\.(mdb|accdb|sql|db|dbf)$"
                    case sensitive: false
          
          # Archive files
          - op: or
            rules:
              - op: and
                rules:
                  - op: is
                    path: event/FILE_CREATE/EVENT_TYPE
                    value: "FILE_CREATE"
                  - op: matches
                    path: event/FILE_CREATE/FILE_PATH
                    re: "\\.(zip|rar|7z|tar|gz)$"
                    case sensitive: false
              - op: and
                rules:
                  - op: is
                    path: event/FILE_DELETE/EVENT_TYPE
                    value: "FILE_DELETE"
                  - op: matches
                    path: event/FILE_DELETE/FILE_PATH
                    re: "\\.(zip|rar|7z|tar|gz)$"
                    case sensitive: false
    
    count: 20     # At least 20 file operations
    within: 60    # Within 1 minute
  
  # Shadow copy deletion (common ransomware behavior)
  with descendant:
    op: and
    rules:
      - op: or
        rules:
          - op: and
            rules:
              - op: is
                path: event/NEW_PROCESS/FILE_PATH
                value: "vssadmin.exe"
                file name: true
              - op: contains
                path: event/NEW_PROCESS/COMMAND_LINE
                value: "delete shadows"
          
          - op: and
            rules:
              - op: is
                path: event/NEW_PROCESS/FILE_PATH
                value: "wmic.exe"
                file name: true
              - op: contains
                path: event/NEW_PROCESS/COMMAND_LINE
                value: "shadowcopy delete"
          
          - op: and
            rules:
              - op: is
                path: event/NEW_PROCESS/FILE_PATH
                value: "bcdedit.exe"
                file name: true
              - op: contains
                path: event/NEW_PROCESS/COMMAND_LINE
                value: "recoveryenabled no"

respond:
  - action: report
    name: "impact"
    priority: 99
    metadata:
      alert_name: "Ransomware Activity Detected"
      technique: "T1486"
      process: "{{.event.NEW_PROCESS.FILE_PATH}}"
      file_count: "{{.count}}"
      shadow_deletion: "{{if .events.NEW_PROCESS}}true{{else}}false{{end}}"
      emergency_response: "true"
      confidence: 95
      tags: "ransomware,file_encryption,mass_deletion,shadow_copy_deletion"
  
  # Immediate containment
  - action: isolate network
  
  - action: task
    command: "os_kill_process"
    arguments:
      pid: "{{.event.NEW_PROCESS.PROCESS_ID}}"
      reason: "Ransomware activity detected"
  
  # Kill all child processes
  - action: task
    command: "os_kill_process_tree"
    arguments:
      pid: "{{.event.NEW_PROCESS.PROCESS_ID}}"
  
  - action: add tag
    tag: "ransomware_victim"
    ttl: 86400
  
  # Emergency incident creation
  - action: extension request
    extension name: "incident_response"
    extension action: "create_emergency_incident"
    extension request:
      severity: "critical"
      category: "ransomware"
      auto_containment: "true"
      evidence:
        process: "{{.event.NEW_PROCESS.FILE_PATH}}"
        file_operations: "{{.count}}"
        sensor_id: "{{.routing.sid}}"
  
  # Collect forensic evidence
  - action: task
    command: "file_get"
    arguments:
      file: "{{.event.NEW_PROCESS.FILE_PATH}}"
  
  - action: task
    command: "mem_map"
    arguments:
      pid: "{{.event.NEW_PROCESS.PROCESS_ID}}"

comment: "Comprehensive ransomware detection with immediate containment and response"
```

---

## Performance Optimization

### Rule Efficiency Guidelines

#### Event Filtering
Always specify event types when possible:

```yaml
# Good - Specific event filtering
events:
  - NEW_PROCESS
  - EXISTING_PROCESS

# Poor - Processes all events
# (no event specification)
```

#### Path Access Optimization
Use direct paths instead of complex queries:

```yaml
# Efficient
path: event/NEW_PROCESS/COMMAND_LINE

# Less efficient
path: event/NEW_PROCESS/MODULES[*]/SIGNATURES[*]/ISSUER
```

#### Operator Selection
Choose the most specific operator:

```yaml
# Good - Exact match when possible
op: is
value: "powershell.exe"

# Less efficient for exact matches
op: contains
value: "powershell.exe"
```

#### Stateless Rules
Use stateless rules when correlation isn't needed:

```yaml
# Stateless for simple detection
is stateless: true
detect:
  op: contains
  path: event/COMMAND_LINE
  value: "malicious_string"
```

### Suppression Best Practices

#### Effective Suppression Keys
Use specific, meaningful suppression keys:

```yaml
suppression:
  keys:
    - "{{.routing.sid}}"                    # Per-sensor
    - "{{.event.NEW_PROCESS.USER_NAME}}"    # Per-user
    - "{{.event.NEW_PROCESS.FILE_PATH}}"    # Per-executable
  max_count: 5
  period: "1h"
```

#### Time-Based Suppression
Adjust suppression periods based on detection type:

```yaml
# Frequent events - longer suppression
suppression:
  period: "6h"
  max_count: 10

# Critical events - shorter suppression
suppression:
  period: "15m"
  max_count: 2
```

---

## Best Practices

### Rule Design Principles

1. **Start Simple**: Begin with basic detection logic and add complexity incrementally
2. **Test Thoroughly**: Use the `tests` parameter to validate rule behavior
3. **Document Clearly**: Include detailed comments explaining rule logic
4. **Optimize Performance**: Use specific event filters and efficient operators
5. **Handle False Positives**: Implement appropriate suppression and context checking

### Security Considerations

1. **Template Security**: Validate template inputs to prevent injection
2. **Resource Access**: Restrict lookup and external resources appropriately
3. **Response Actions**: Ensure response actions are proportional to threat level
4. **Sensitive Data**: Avoid logging sensitive information in rule output

### Operational Guidelines

1. **Monitoring**: Track rule performance and false positive rates
2. **Maintenance**: Regularly review and update rules based on threat landscape
3. **Documentation**: Maintain detailed documentation of rule purpose and logic
4. **Testing**: Test rules in non-production environments before deployment

---

## Troubleshooting

### Common Issues

#### Rule Not Triggering
- Check event type filters match actual events
- Verify path selectors point to existing data
- Confirm operator parameters are correct
- Test with debug mode enabled

#### Performance Issues
- Add specific event type filters
- Optimize path selectors
- Consider using stateless mode
- Review suppression settings

#### False Positives
- Add contextual filters (time, tags, user accounts)
- Implement proper suppression
- Refine detection logic specificity
- Use confidence scoring

#### Template Errors
- Validate Go template syntax
- Check path references exist in event data
- Test secret and variable references
- Use conditional logic for optional fields

### Debug Mode
Enable debug mode for detailed rule execution information:

```yaml
debug: true
detect:
  op: contains
  path: event/COMMAND_LINE
  value: "test"
```

### Testing Framework
Use the built-in testing framework to validate rule logic:

```yaml
tests:
  match:
    - - name: "Should detect PowerShell with encoded command"
        event:
          NEW_PROCESS:
            COMMAND_LINE: "powershell -encodedcommand ZQBjaABvACAAIgBoAGUAbABsAG8AIgA="
            FILE_PATH: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
  not_match:
    - - name: "Should not detect normal PowerShell"
        event:
          NEW_PROCESS:
            COMMAND_LINE: "powershell -command Get-Process"
            FILE_PATH: "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
```

---

## Conclusion

This comprehensive guidebook covers all aspects of LimaCharlie's D&R rule system, from basic syntax to advanced multi-stage detection. The examples provided demonstrate real-world cybersecurity use cases across all target types, with detailed explanations of component interactions and optimization techniques.

Key takeaways:
- Use appropriate target types for different data sources
- Leverage stateful detection for complex attack patterns
- Implement proper suppression to manage alert volume
- Optimize rules for performance and accuracy
- Test thoroughly and document clearly

The D&R engine's flexibility enables sophisticated threat detection and automated response capabilities that can adapt to evolving security requirements and threat landscapes.