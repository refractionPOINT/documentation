# USP Adapter Configuration for Auth Log Syslog Parsing
# Comprehensive grok patterns for all auth.log message sub-types

syslog:
  port: 1514
  iface: "0.0.0.0"
  is_udp: false

  client_options:
    identity:
      oid: "YOUR_ORG_ID_HERE"
      installation_key: "YOUR_INSTALLATION_KEY_HERE"

    hostname: "auth-log-adapter"
    platform: "text"
    sensor_seed_key: "auth-log-collector"

    mapping:
      parsing_grok:
        # Custom username pattern (alphanumeric, underscore, hyphen, dot)
        USERNAME: "[a-zA-Z0-9._-]+"

        # SSH Authentication Events
        SSH_INVALID_USER: "Invalid user %{USERNAME:user} from %{IP:src_ip} port %{NUMBER:src_port}"
        SSH_FAILED_INVALID: "Failed password for invalid user %{USERNAME:user} from %{IP:src_ip} port %{NUMBER:src_port} ssh2"
        SSH_FAILED_VALID: "Failed password for %{USERNAME:user} from %{IP:src_ip} port %{NUMBER:src_port} ssh2"
        SSH_ACCEPTED_PUBKEY: "Accepted publickey for %{USERNAME:user} from %{IP:src_ip} port %{NUMBER:src_port} ssh2: %{WORD:key_type} %{NOTSPACE:key_fingerprint}"

        # SSH Connection Events
        SSH_CONN_CLOSED_INVALID: "Connection closed by invalid user %{USERNAME:user} %{IP:src_ip} port %{NUMBER:src_port} \\[preauth\\]"
        SSH_CONN_CLOSED_AUTH: "Connection closed by authenticating user %{USERNAME:user} %{IP:src_ip} port %{NUMBER:src_port} \\[preauth\\]"
        SSH_DISCONNECTED_INVALID: "Disconnected from invalid user %{USERNAME:user} %{IP:src_ip} port %{NUMBER:src_port} \\[preauth\\]"
        SSH_DISCONNECTED_AUTH: "Disconnected from authenticating user %{USERNAME:user} %{IP:src_ip} port %{NUMBER:src_port} \\[preauth\\]"
        SSH_RECEIVED_DISCONNECT: "Received disconnect from %{IP:src_ip} port %{NUMBER:src_port}:%{NUMBER:disconnect_code}: %{GREEDYDATA:disconnect_reason}"

        # PAM Events
        PAM_CHECK_PASS: "pam_unix\\(%{WORD:pam_service}:%{WORD:pam_action}\\): check pass; user unknown"
        PAM_AUTH_FAILURE_WITH_USER: "pam_unix\\(%{WORD:pam_service}:%{WORD:pam_action}\\): authentication failure; logname=%{DATA} uid=%{NUMBER:uid} euid=%{NUMBER:euid} tty=%{WORD:tty} ruser=%{DATA} rhost=%{IP:src_ip}  user=%{USERNAME:user}"
        PAM_AUTH_FAILURE_NO_USER: "pam_unix\\(%{WORD:pam_service}:%{WORD:pam_action}\\): authentication failure; logname=%{DATA} uid=%{NUMBER:uid} euid=%{NUMBER:euid} tty=%{WORD:tty} ruser=%{DATA} rhost=%{IP:src_ip}"
        PAM_SESSION_OPENED: "pam_unix\\(%{WORD:pam_service}:%{WORD:pam_action}\\): session opened for user %{USERNAME:user}\\(uid=%{NUMBER:uid}\\) by %{DATA:opened_by}\\(uid=%{NUMBER:opened_by_uid}\\)"
        PAM_SESSION_CLOSED: "pam_unix\\(%{WORD:pam_service}:%{WORD:pam_action}\\): session closed for user %{USERNAME:user}"
        PAM_MORE_FAILURES: "PAM %{NUMBER:failure_count} more authentication failures; logname=%{DATA} uid=%{NUMBER:uid} euid=%{NUMBER:euid} tty=%{WORD:tty} ruser=%{DATA} rhost=%{IP:src_ip}  user=%{USERNAME:user}"

        # Sudo Events (process is "sudo" not "sudo:")
        # Note: sudo logs have leading whitespace before the username
        SUDO_COMMAND: " *%{USERNAME:invoking_user} : TTY=%{NOTSPACE:tty} ; PWD=%{NOTSPACE:pwd} ; USER=%{USERNAME:target_user} ; COMMAND=%{GREEDYDATA:command}"

        # Combined message types with alternation
        SSH_EVENTS: "(%{SSH_INVALID_USER}|%{SSH_FAILED_INVALID}|%{SSH_FAILED_VALID}|%{SSH_ACCEPTED_PUBKEY}|%{SSH_CONN_CLOSED_INVALID}|%{SSH_CONN_CLOSED_AUTH}|%{SSH_DISCONNECTED_INVALID}|%{SSH_DISCONNECTED_AUTH}|%{SSH_RECEIVED_DISCONNECT})"
        PAM_EVENTS: "(%{PAM_CHECK_PASS}|%{PAM_AUTH_FAILURE_WITH_USER}|%{PAM_AUTH_FAILURE_NO_USER}|%{PAM_SESSION_OPENED}|%{PAM_SESSION_CLOSED}|%{PAM_MORE_FAILURES})"
        SUDO_EVENTS: "(%{SUDO_COMMAND})"
        ALL_MESSAGES: "(%{SSH_EVENTS}|%{PAM_EVENTS}|%{SUDO_EVENTS}|%{GREEDYDATA:log_message})"

        # Root pattern - syslog envelope with message type detection
        message: "<%{NUMBER:syslog_pri}>%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:hostname} %{WORD:process}(\\[%{NUMBER:pid}\\])?: %{ALL_MESSAGES}"

      # Extract hostname from the parsed fields
      sensor_hostname_path: "hostname"

      # Use process name as event type (sshd, sudo, etc.)
      event_type_path: "process"

    # Index key fields for fast searching - now using structured fields
    indexing:
      - path: "hostname"
        index_type: "domain"

      - path: "process"
        index_type: "service_name"

      # Index source IP from structured field
      - path: "src_ip"
        index_type: "ip"

      # Index usernames from structured fields
      - path: "user"
        index_type: "user"

      - path: "invoking_user"
        index_type: "user"

      - path: "target_user"
        index_type: "user"
