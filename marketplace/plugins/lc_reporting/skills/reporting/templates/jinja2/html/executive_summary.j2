<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Summary - {{ org_info.name|default('N/A') }}</title>

    <!-- Chart.js for interactive visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Chart.js default configuration
        // Using LimaCharlie brand colors
        Chart.defaults.color = '#333';
        Chart.defaults.borderColor = '#e0e0e0';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';

        // Brand colors for consistent styling across all charts
        const brandColors = {
            primary: '#667eea',
            secondary: '#764ba2',
            accent: '#4F9EEE',
            success: '#28a745',
            warning: '#ffc107',
            danger: '#dc3545',
            info: '#17a2b8'
        };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: white;
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }

        .header p {
            opacity: 0.9;
            margin: 5px 0;
            font-size: 1.1em;
        }

        /* KPI Dashboard Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .kpi-card.status-good { border-left: 5px solid #28a745; }
        .kpi-card.status-warning { border-left: 5px solid #ffc107; }
        .kpi-card.status-danger { border-left: 5px solid #dc3545; }
        .kpi-card.status-info { border-left: 5px solid #667eea; }

        .kpi-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 3em;
            font-weight: bold;
            color: #333;
            line-height: 1;
        }

        .kpi-subtext {
            font-size: 0.95em;
            color: #666;
            margin-top: 10px;
        }

        .kpi-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin: 0 0 20px 0;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            font-size: 1.5em;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .chart-container canvas {
            max-height: 350px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .footer {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .kpi-value {
                font-size: 2em;
            }
        }

        @media print {
            body {
                background: white;
            }
            .card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Executive Summary</h1>
            <p><strong>{{ org_info.name|default('N/A') }}</strong></p>
            <p>Generated: {{ report_metadata.generated_at }}</p>
            <p>Period: {{ report_metadata.start_date }} to {{ report_metadata.end_date }} ({{ report_metadata.time_range_days }} days)</p>
        </div>

        <!-- KPI Dashboard -->
        <div class="kpi-grid">
            <div class="kpi-card status-info">
                <div class="kpi-icon">üíª</div>
                <div class="kpi-label">Total Sensors</div>
                <div class="kpi-value">{{ sensor_stats.total }}</div>
                <div class="kpi-subtext">Quota: {{ org_info.sensor_quota|default('N/A') }}</div>
            </div>

            <div class="kpi-card {% if sensor_stats.online_percentage >= 95 %}status-good{% elif sensor_stats.online_percentage >= 80 %}status-warning{% else %}status-danger{% endif %}">
                <div class="kpi-icon">‚úÖ</div>
                <div class="kpi-label">Availability</div>
                <div class="kpi-value">{{ sensor_stats.online_percentage }}%</div>
                <div class="kpi-subtext">{{ sensor_stats.online }} of {{ sensor_stats.total }} online</div>
            </div>

            <div class="kpi-card status-info">
                <div class="kpi-icon">üîí</div>
                <div class="kpi-label">Total Detections</div>
                <div class="kpi-value">{{ "{:,}".format(detection_summary.total) }}</div>
                <div class="kpi-subtext">{{ detection_summary.avg_per_day }} per day average</div>
            </div>

            <div class="kpi-card status-info">
                <div class="kpi-icon">‚öôÔ∏è</div>
                <div class="kpi-label">Active Rules</div>
                <div class="kpi-value">{{ config_summary.dr_rules }}</div>
                <div class="kpi-subtext">Detection & Response</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="two-column">
            <!-- Sensor Status Chart -->
            <div class="card">
                <h2>üíª Sensor Status</h2>
                <div class="chart-container">
                    <canvas id="sensorStatusChart"></canvas>
                </div>

                <script>
                    // Chart: Sensor Status - Doughnut Chart
                    // Shows online vs offline sensor distribution
                    new Chart(document.getElementById('sensorStatusChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Online', 'Offline'],
                            datasets: [{
                                data: [{{ sensor_stats.online }}, {{ sensor_stats.offline }}],
                                backgroundColor: [
                                    brandColors.success,  // Green for online
                                    brandColors.danger    // Red for offline
                                ],
                                borderColor: '#fff',
                                borderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        font: { size: 14 }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label + ': ';
                                            label += context.parsed.toLocaleString() + ' sensors';
                                            let pct = ((context.parsed / {{ sensor_stats.total }}) * 100).toFixed(1);
                                            label += ' (' + pct + '%)';
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                </script>
            </div>

            <!-- Platform Distribution -->
            <div class="card">
                <h2>üìä Platform Distribution</h2>
                <div class="chart-container">
                    <canvas id="platformChart"></canvas>
                </div>

                <script>
                    // Chart: Platform Distribution - Horizontal Bar Chart
                    // Shows sensor distribution across platforms
                    {% set platforms_sorted = sensor_stats.by_platform.items()|sort(attribute='1', reverse=True)|list %}
                    new Chart(document.getElementById('platformChart'), {
                        type: 'bar',
                        data: {
                            labels: {{ platforms_sorted|map(attribute='0')|list|tojson }},
                            datasets: [{
                                label: 'Sensors',
                                data: {{ platforms_sorted|map(attribute='1')|list|tojson }},
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: brandColors.primary,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            indexAxis: 'y',  // Horizontal bars
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    callbacks: {
                                        label: function(context) {
                                            return 'Sensors: ' + context.parsed.x.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Number of Sensors',
                                        font: { size: 12, weight: 'bold' }
                                    }
                                }
                            }
                        }
                    });
                </script>
            </div>
        </div>

        {% if detection_summary.by_day %}
        <!-- Detection Trend -->
        <div class="card">
            <h2>üìà Detection Activity Trend</h2>
            <div class="chart-container">
                <canvas id="detectionTrendChart"></canvas>
            </div>

            <script>
                // Chart: Detection Trend - Line Chart
                // Shows detection volume over time
                {% set detection_days = detection_summary.by_day.items()|sort %}
                new Chart(document.getElementById('detectionTrendChart'), {
                    type: 'line',
                    data: {
                        labels: {{ detection_days|map(attribute='0')|list|tojson }},
                        datasets: [{
                            label: 'Daily Detections',
                            data: {{ detection_days|map(attribute='1')|list|tojson }},
                            borderColor: brandColors.primary,
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: brandColors.primary,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        return 'Detections: ' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Detections',
                                    font: { size: 12, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: { size: 12, weight: 'bold' }
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            </script>
        </div>
        {% endif %}

        {% if detection_summary.by_category %}
        <!-- Top Detection Categories -->
        <div class="card">
            <h2>üéØ Top Detection Categories</h2>
            <div class="chart-container">
                <canvas id="categoriesChart"></canvas>
            </div>

            <script>
                // Chart: Top Detection Categories - Horizontal Bar Chart
                // Shows most common detection types
                {% set top_cats = (detection_summary.by_category.items()|sort(attribute='1', reverse=True)|list)[:8] %}
                new Chart(document.getElementById('categoriesChart'), {
                    type: 'bar',
                    data: {
                        labels: {{ top_cats|map(attribute='0')|list|tojson }},
                        datasets: [{
                            label: 'Detections',
                            data: {{ top_cats|map(attribute='1')|list|tojson }},
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(79, 158, 238, 0.8)',
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(23, 162, 184, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(108, 117, 125, 0.8)'
                            ],
                            borderColor: [
                                '#667eea', '#764ba2', '#4F9EEE', '#28a745',
                                '#17a2b8', '#ffc107', '#dc3545', '#6c757d'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        indexAxis: 'y',  // Horizontal bars
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        let label = 'Detections: ' + context.parsed.x.toLocaleString();
                                        let pct = ((context.parsed.x / {{ detection_summary.total }}) * 100).toFixed(1);
                                        label += ' (' + pct + '%)';
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Detections',
                                    font: { size: 12, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            </script>
        </div>
        {% endif %}

        <!-- Configuration Summary -->
        <div class="card">
            <h2>‚öôÔ∏è Configuration Overview</h2>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th style="text-align: right;">Count</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>D&R Rules</strong></td>
                        <td style="text-align: right;">{{ config_summary.dr_rules }}</td>
                    </tr>
                    <tr>
                        <td><strong>Outputs</strong></td>
                        <td style="text-align: right;">{{ config_summary.outputs }}</td>
                    </tr>
                    <tr>
                        <td><strong>Tags</strong></td>
                        <td style="text-align: right;">{{ config_summary.tags }}</td>
                    </tr>
                    <tr>
                        <td><strong>Users</strong></td>
                        <td style="text-align: right;">{{ config_summary.users }}</td>
                    </tr>
                    <tr>
                        <td><strong>API Keys</strong></td>
                        <td style="text-align: right;">{{ config_summary.api_keys }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        {% if usage_summary and 'error' not in usage_summary %}
        <!-- Usage Statistics -->
        <div class="card">
            <h2>üìä Latest Usage Statistics</h2>
            <p style="margin-bottom: 15px;"><strong>Date:</strong> {{ usage_summary.date }}</p>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th style="text-align: right;">Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Sensor Events</strong></td>
                        <td style="text-align: right;">{{ "{:,}".format(usage_summary.sensor_events) }}</td>
                    </tr>
                    <tr>
                        <td><strong>D&R Evaluations</strong></td>
                        <td style="text-align: right;">{{ "{:,}".format(usage_summary.detections_generated) }}</td>
                    </tr>
                    <tr>
                        <td><strong>Output Data</strong></td>
                        <td style="text-align: right;">{{ usage_summary.output_bytes_gb }} GB</td>
                    </tr>
                    <tr>
                        <td><strong>Peak Concurrent Sensors</strong></td>
                        <td style="text-align: right;">{{ usage_summary.peak_sensors }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="footer">
            <p>Generated by LimaCharlie Reporting Framework</p>
            <p style="font-size: 0.85em; color: #999; margin-top: 5px;">Organization ID: {{ org_info.oid|default('N/A') }}</p>
        </div>
    </div>
</body>
</html>
