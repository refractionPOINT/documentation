{#
  Multi-Tenant Billing Summary Template

  Displays billing roll-up and per-tenant breakdown with SKU details.

  DATA ACCURACY GUARDRAILS:
  - This template ONLY displays data provided in the context
  - Missing data shows "N/A" or "Data unavailable"
  - All warnings are displayed in a dedicated section
  - No data is fabricated, estimated, or interpolated
  - Cost figures come directly from LimaCharlie billing API
#}
{% extends 'base.html.j2' %}

{% block title %}Multi-Tenant Billing Report - {{ metadata.period | default('Current Period') }}{% endblock %}

{% block extra_styles %}
<style>
    .header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #059669, #10b981);
        color: #fff;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo svg { width: 48px; height: 48px; }
    .logo span { font-size: 1.5rem; font-weight: 700; }
    .meta { display: flex; gap: 2rem; font-size: 0.875rem; opacity: 0.9; }
    .meta dt { font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; }
    .meta dd { font-weight: 600; margin-top: 0.25rem; }

    .cost-highlight { font-size: 1.125rem; font-weight: 700; color: var(--color-success); }

    /* Expandable tenant cards */
    .tenant-card {
        background: var(--color-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-bottom: 0.75rem;
        overflow: hidden;
    }
    .tenant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        cursor: pointer;
        user-select: none;
        transition: background 0.15s ease;
    }
    .tenant-header:hover {
        background: var(--color-bg);
    }
    .tenant-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .tenant-expand-icon {
        width: 20px;
        height: 20px;
        color: var(--color-text-muted);
        transition: transform 0.2s ease;
    }
    .tenant-card.expanded .tenant-expand-icon {
        transform: rotate(90deg);
    }
    .tenant-name { font-size: 1rem; font-weight: 600; }
    .tenant-meta { font-size: 0.8rem; color: var(--color-text-muted); }
    .tenant-cost { font-size: 1.25rem; font-weight: 700; color: var(--color-success); }
    .tenant-cost.zero { color: var(--color-text-muted); }

    .tenant-details {
        display: none;
        padding: 0 1.25rem 1.25rem 1.25rem;
        border-top: 1px solid var(--color-border);
    }
    .tenant-card.expanded .tenant-details {
        display: block;
    }

    .sku-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.875rem;
    }
    .sku-row:last-child { border-bottom: none; }
    .sku-name { color: var(--color-text-muted); }
    .sku-amount { font-weight: 500; }
    .progress-bar {
        height: 6px;
        background: var(--color-border);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.75rem;
    }
    .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    .badge-region {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* Expand all button */
    .expand-controls {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
        gap: 0.5rem;
    }
    .expand-btn {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        background: var(--color-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .expand-btn:hover {
        background: var(--color-border);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">

    {# ================================================================
       REPORT HEADER
       ================================================================ #}
    <header class="header">
        <div class="logo">
            <svg viewBox="0 0 48 48" fill="none"><rect width="48" height="48" rx="10" fill="rgba(255,255,255,0.2)"/><path d="M12 18h6v18h-6V18zm9-6h6v24h-6V12zm9 12h6v12h-6V24z" fill="white"/></svg>
            <span>LimaCharlie</span>
        </div>
        <div>
            <h1>Multi-Tenant Billing Report</h1>
            <dl class="meta">
                <div><dt>Period</dt><dd>{{ metadata.period | default('N/A') }}</dd></div>
                <div><dt>Generated</dt><dd>{{ metadata.generated_at | default('N/A') }}</dd></div>
                <div><dt>Tenants</dt><dd>{{ metadata.tenant_count | default(data.tenants | length) }} organizations</dd></div>
            </dl>
        </div>
    </header>

    {# ================================================================
       EXECUTIVE SUMMARY - MOVED TO TOP
       ================================================================ #}
    {% set success_count = data.tenants | selectattr('status', 'equalto', 'success') | list | length %}
    {% set error_count = data.tenants | selectattr('status', 'equalto', 'error') | list | length %}
    {% set no_invoice_count = data.tenants | selectattr('status', 'equalto', 'no_invoice') | list | length %}
    {% set total_tenants = data.tenants | length %}
    {% set failed_count = error_count + no_invoice_count %}
    {% set completeness_pct = ((success_count / total_tenants) * 100) | round(0) | int if total_tenants > 0 else 0 %}

    <section class="dashboard-section" aria-labelledby="rollup-heading">
        <h2 id="rollup-heading">Executive Summary</h2>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="card-icon green">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value" style="color: var(--color-success);">
                        {% if data.rollup and data.rollup.total_cost is defined %}
                            ${{ data.rollup.total_cost | format_number }}
                        {% else %}
                            <span class="na">N/A</span>
                        {% endif %}
                    </span>
                    <span class="card-label">Total Billed Amount</span>
                    <span class="card-subvalue">{{ success_count }} organization{{ 's' if success_count != 1 else '' }} with successful invoices</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">{{ success_count }}</span>
                    <span class="card-label">Organizations with Invoices</span>
                    <span class="card-subvalue">{{ completeness_pct }}% of total organizations</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon red">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">{{ failed_count }}</span>
                    <span class="card-label">Organizations without Invoices</span>
                    <span class="card-subvalue">{{ no_invoice_count }} no invoice, {{ error_count }} permission denied</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon amber">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">{{ completeness_pct }}%</span>
                    <span class="card-label">Data Completeness</span>
                    <span class="card-subvalue">{{ success_count }} of {{ total_tenants }} organizations successfully retrieved</span>
                </div>
            </div>
        </div>
    </section>

    {# ================================================================
       DISTRIBUTION CHARTS - IMMEDIATELY AFTER SUMMARY
       ================================================================ #}
    {% if data.tenants and data.tenants | length > 0 %}
    <section class="dashboard-section">
        <h2>Distribution Overview</h2>
        <div class="chart-grid two-column">
            <div class="chart-container">
                <h3 class="chart-title">Cost Distribution by Organization</h3>
                <canvas id="costDistChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Data Retrieval Status</h3>
                <canvas id="statusDistChart"></canvas>
            </div>
        </div>
    </section>
    {% endif %}

    {# ================================================================
       WARNINGS AND ERRORS - SHOW EARLY IF PRESENT
       ================================================================ #}
    {% if warnings or errors %}
    <section class="dashboard-section warnings-section">
        <h2>Data Limitations & Warnings</h2>

        {% if warnings %}
        <div class="warning-list">
            {% for warning in warnings %}
            <div class="warning-item">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span>{{ warning }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if errors %}
        <details style="margin-top: 1rem;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--color-text-muted);">
                {{ errors | length }} organization{{ 's' if errors | length != 1 else '' }} without billing access (click to expand)
            </summary>
            <div class="error-list" style="margin-top: 0.75rem;">
                {% for error in errors %}
                <div class="error-item">
                    <strong>{{ error.org_name | default('Unknown') }}</strong>
                    <p>{{ error.error_message | default('Permission denied') }}</p>
                </div>
                {% endfor %}
            </div>
        </details>
        {% endif %}
    </section>
    {% endif %}

    {# ================================================================
       PER-TENANT BREAKDOWN - UNIFIED EXPANDABLE VIEW
       ================================================================ #}
    {% if data.tenants and data.tenants | length > 0 %}
    <section class="dashboard-section">
        <h2>Per-Organization Breakdown</h2>

        <div class="expand-controls">
            <button class="expand-btn" onclick="expandAllTenants()">Expand All</button>
            <button class="expand-btn" onclick="collapseAllTenants()">Collapse All</button>
        </div>

        {# Sort tenants: successful with costs first, then successful with $0, then errors #}
        {% set sorted_tenants = data.tenants | sort(attribute='cost', reverse=true) %}

        {% for tenant in sorted_tenants %}
        <div class="tenant-card" id="tenant-{{ loop.index }}"
             {% if tenant.status == 'error' %}style="opacity: 0.6; border-left: 3px solid var(--color-danger);"
             {% elif tenant.status == 'no_invoice' %}style="opacity: 0.7; border-left: 3px solid #94a3b8;"
             {% elif tenant.cost == 0 %}style="opacity: 0.8;"{% endif %}>
            <div class="tenant-header" onclick="toggleTenant('tenant-{{ loop.index }}')">
                <div class="tenant-header-left">
                    <svg class="tenant-expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                    <div>
                        <div class="tenant-name">
                            {{ tenant.name }}
                            {% if tenant.status == 'error' %}
                            <span class="status-badge status-failed" style="margin-left: 0.5rem; font-size: 0.7rem;">Permission Denied</span>
                            {% elif tenant.status == 'no_invoice' %}
                            <span class="status-badge" style="background: #e2e8f0; color: #64748b; margin-left: 0.5rem; font-size: 0.7rem;">No Invoice</span>
                            {% endif %}
                        </div>
                        <div class="tenant-meta">
                            {% if tenant.status == 'success' %}
                                {{ tenant.skus | length if tenant.skus else 0 }} line items
                                {% if data.rollup and data.rollup.total_cost and data.rollup.total_cost > 0 and tenant.cost %}
                                 | {{ ((tenant.cost / data.rollup.total_cost) * 100) | round(1) }}% of total
                                {% endif %}
                            {% elif tenant.status == 'error' %}
                                Missing billing.ctrl permission
                            {% else %}
                                No active billing this period
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="tenant-cost {% if tenant.cost == 0 or tenant.status != 'success' %}zero{% endif %}">
                    {% if tenant.status == 'success' %}
                        ${{ tenant.cost | default(0) | format_number }}
                    {% else %}
                        ‚Äî
                    {% endif %}
                </div>
            </div>

            <div class="tenant-details">
                {% if tenant.status == 'error' %}
                <div style="text-align: center; padding: 1rem; color: var(--color-text-muted);">
                    <span style="color: var(--color-danger);">‚ö†Ô∏è</span> Cannot retrieve billing data - missing <code>billing.ctrl</code> permission
                </div>
                {% elif tenant.status == 'no_invoice' %}
                <div style="text-align: center; padding: 1rem; color: var(--color-text-muted);">
                    No invoice found for this billing period
                </div>
                {% elif tenant.skus and tenant.skus | length > 0 %}
                    {% for sku in tenant.skus %}
                    <div class="sku-row">
                        <span class="sku-name">{{ sku.description }}{% if sku.quantity %} ({{ sku.quantity }}){% endif %}</span>
                        <span class="sku-amount">${{ sku.amount | format_number }}</span>
                    </div>
                    {% endfor %}

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {% if data.rollup and data.rollup.total_cost and data.rollup.total_cost > 0 %}{{ ((tenant.cost | default(0)) / data.rollup.total_cost * 100) | round(1) }}{% else %}0{% endif %}%; background: var(--color-primary);"></div>
                    </div>
                {% elif tenant.cost == 0 %}
                <div style="text-align: center; padding: 1rem; color: var(--color-text-muted);">
                    No billable usage this period
                </div>
                {% else %}
                <div style="text-align: center; padding: 1rem; color: var(--color-text-muted);">
                    SKU details not available
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        {# Summary footer #}
        <div style="margin-top: 1rem; padding: 1rem; background: var(--color-bg); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
            <span><strong>{{ data.tenants | length }}</strong> organizations total</span>
            <span style="font-size: 1.25rem; font-weight: 700; color: var(--color-success);">
                Total: ${{ (data.rollup.total_cost if data.rollup and data.rollup.total_cost else 0) | format_number }}
            </span>
        </div>
    </section>
    {% else %}
    <section class="dashboard-section">
        <h2>Per-Organization Breakdown</h2>
        <div class="chart-unavailable">
            <span class="icon">üìã</span>
            <p>No tenant billing data available</p>
        </div>
    </section>
    {% endif %}

    {# ================================================================
       COST BY CATEGORY (if available)
       ================================================================ #}
    {% if data.categories and data.categories | length > 0 %}
    <section class="dashboard-section">
        <h2>Cost by Category (All Tenants)</h2>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
    </section>
    {% endif %}

    <footer style="margin-top: 2rem; padding: 1rem; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: var(--radius-md); font-size: 0.875rem;">
        <strong>Data Accuracy:</strong> All billing figures sourced directly from LimaCharlie billing API.
        Organizations without billing.ctrl permission excluded.
        No data has been fabricated, estimated, or interpolated.
    </footer>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Toggle individual tenant expansion
    function toggleTenant(id) {
        const card = document.getElementById(id);
        card.classList.toggle('expanded');
    }

    // Expand all tenant cards
    function expandAllTenants() {
        document.querySelectorAll('.tenant-card').forEach(card => {
            card.classList.add('expanded');
        });
    }

    // Collapse all tenant cards
    function collapseAllTenants() {
        document.querySelectorAll('.tenant-card').forEach(card => {
            card.classList.remove('expanded');
        });
    }

    {% if data.tenants and data.tenants | length > 0 %}
    // Cost Distribution Doughnut Chart - Only show orgs with costs
    {% set tenants_with_cost = data.tenants | selectattr('cost', 'defined') | selectattr('cost', 'gt', 0) | list %}
    {% if tenants_with_cost | length > 0 %}
    new Chart(document.getElementById('costDistChart'), {
        type: 'doughnut',
        data: {
            labels: [{% for t in tenants_with_cost %}'{{ t.name | truncate(20) }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for t in tenants_with_cost %}{{ t.cost | default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#0ea5e9', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#14b8a6', '#ec4899', '#6366f1'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '55%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: { label: (ctx) => ` ${ctx.label}: $${ctx.raw.toLocaleString()}` }
                }
            }
        }
    });
    {% endif %}

    // Status Distribution Doughnut Chart
    {% set success_count = data.tenants | selectattr('status', 'equalto', 'success') | list | length %}
    {% set error_count = data.tenants | selectattr('status', 'equalto', 'error') | list | length %}
    {% set no_invoice_count = data.tenants | selectattr('status', 'equalto', 'no_invoice') | list | length %}
    new Chart(document.getElementById('statusDistChart'), {
        type: 'doughnut',
        data: {
            labels: ['Success ({{ success_count }})', 'Permission Denied ({{ error_count }})', 'No Invoice ({{ no_invoice_count }})'],
            datasets: [{
                data: [{{ success_count }}, {{ error_count }}, {{ no_invoice_count }}],
                backgroundColor: ['#22c55e', '#ef4444', '#94a3b8'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '55%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: { label: (ctx) => ` ${ctx.raw} organizations` }
                }
            }
        }
    });
    {% endif %}

    {% if data.categories and data.categories | length > 0 %}
    // Category Bar Chart
    new Chart(document.getElementById('categoryChart'), {
        type: 'bar',
        data: {
            labels: [{% for cat in data.categories %}'{{ cat.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for cat in data.categories %}{{ cat.amount }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#0ea5e9', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#14b8a6'],
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { callback: (v) => '$' + (v/1000).toFixed(0) + 'k' } }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
