{#
  Multi-Tenant Billing Summary Template

  Displays billing roll-up and per-tenant breakdown with SKU details.

  DATA ACCURACY GUARDRAILS:
  - This template ONLY displays data provided in the context
  - Missing data shows "N/A" or "Data unavailable"
  - All warnings are displayed in a dedicated section
  - No data is fabricated, estimated, or interpolated
  - Cost figures come directly from LimaCharlie billing API
#}
{% extends 'base.html.j2' %}

{% block title %}Multi-Tenant Billing Report - {{ metadata.period | default('Current Period') }}{% endblock %}

{% block extra_styles %}
<style>
    .header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #059669, #10b981);
        color: #fff;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo svg { width: 48px; height: 48px; }
    .logo span { font-size: 1.5rem; font-weight: 700; }
    .meta { display: flex; gap: 2rem; font-size: 0.875rem; opacity: 0.9; }
    .meta dt { font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; }
    .meta dd { font-weight: 600; margin-top: 0.25rem; }

    .cost-highlight { font-size: 1.125rem; font-weight: 700; color: var(--color-success); }
    .tenant-card {
        padding: 1.25rem;
        background: var(--color-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-bottom: 1rem;
    }
    .tenant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--color-border);
    }
    .tenant-name { font-size: 1.125rem; font-weight: 600; }
    .tenant-cost { font-size: 1.5rem; font-weight: 700; color: var(--color-success); }
    .sku-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8fafc;
        font-size: 0.875rem;
    }
    .sku-row:last-child { border-bottom: none; }
    .sku-name { color: var(--color-text-muted); }
    .sku-amount { font-weight: 500; }
    .progress-bar {
        height: 8px;
        background: var(--color-border);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    .badge-region {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">

    {# ================================================================
       REPORT HEADER
       ================================================================ #}
    <header class="header">
        <div class="logo">
            <svg viewBox="0 0 48 48" fill="none"><rect width="48" height="48" rx="10" fill="rgba(255,255,255,0.2)"/><path d="M12 18h6v18h-6V18zm9-6h6v24h-6V12zm9 12h6v12h-6V24z" fill="white"/></svg>
            <span>LimaCharlie</span>
        </div>
        <div>
            <h1>Multi-Tenant Billing Report</h1>
            <dl class="meta">
                <div><dt>Period</dt><dd>{{ metadata.period | default('N/A') }}</dd></div>
                <div><dt>Generated</dt><dd>{{ metadata.generated_at | default('N/A') }}</dd></div>
                <div><dt>Tenants</dt><dd>{{ metadata.tenant_count | default(data.tenants | length) }} organizations</dd></div>
            </dl>
        </div>
    </header>

    {# ================================================================
       EXECUTIVE SUMMARY ROLL-UP
       GUARDRAIL: All values come directly from data.rollup
       ================================================================ #}
    <section class="dashboard-section" aria-labelledby="rollup-heading">
        <h2 id="rollup-heading">Executive Summary (Roll-Up)</h2>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="card-icon green">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value" style="color: var(--color-success);">
                        {% if data.rollup and data.rollup.total_cost is defined %}
                            ${{ data.rollup.total_cost | format_number }}
                        {% else %}
                            <span class="na">N/A</span>
                        {% endif %}
                    </span>
                    <span class="card-label">Total Monthly Billing</span>
                    <span class="card-subvalue">All tenants combined</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">
                        {% if data.rollup.successful_count is defined %}
                            {{ data.rollup.successful_count }}
                        {% else %}
                            {{ data.tenants | selectattr('status', 'equalto', 'success') | list | length }}
                        {% endif %}
                    </span>
                    <span class="card-label">Successful</span>
                    <span class="card-subvalue">Organizations with billing data</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon red">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">
                        {% if data.rollup.failed_count is defined %}
                            {{ data.rollup.failed_count }}
                        {% else %}
                            {{ data.tenants | rejectattr('status', 'equalto', 'success') | list | length }}
                        {% endif %}
                    </span>
                    <span class="card-label">Failed/No Invoice</span>
                    <span class="card-subvalue">Organizations without data</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon amber">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">{{ data.tenants | length }}</span>
                    <span class="card-label">Active Tenants</span>
                    <span class="card-subvalue">With billing data</span>
                </div>
            </div>
        </div>
    </section>

    {# ================================================================
       DISTRIBUTION CHARTS
       ================================================================ #}
    {% if data.tenants and data.tenants | length > 0 %}
    <section class="dashboard-section">
        <h2>Cost Distribution</h2>
        <div class="chart-grid two-column">
            <div class="chart-container">
                <h3 class="chart-title">Cost Distribution by Tenant</h3>
                <canvas id="costDistChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Status Breakdown</h3>
                <canvas id="statusDistChart"></canvas>
            </div>
        </div>
    </section>
    {% endif %}

    {# ================================================================
       PER-TENANT BREAKDOWN TABLE
       ================================================================ #}
    <section class="dashboard-section">
        <h2>Per-Tenant Breakdown</h2>

        {% if data.tenants and data.tenants | length > 0 %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Organization</th>
                        <th class="number">Monthly Cost</th>
                        <th class="number">% of Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tenant in data.tenants %}
                    <tr>
                        <td><strong>{{ tenant.name | default('N/A') }}</strong></td>
                        <td class="number cost-highlight">${{ tenant.cost | default(0) | format_number }}</td>
                        <td class="number">
                            {% if data.rollup and data.rollup.total_cost and data.rollup.total_cost > 0 and tenant.cost %}
                                {{ ((tenant.cost / data.rollup.total_cost) * 100) | round(1) }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if tenant.status == 'success' %}
                            <span class="status-badge status-success">Success</span>
                            {% elif tenant.status == 'error' %}
                            <span class="status-badge status-failed">Error</span>
                            {% elif tenant.status == 'no_invoice' %}
                            <span class="status-badge" style="background: #dbeafe; color: #1d4ed8;">No Invoice</span>
                            {% elif tenant.cost == 0 %}
                            <span class="status-badge" style="background: #f3f4f6; color: #6b7280;">No Usage</span>
                            {% else %}
                            <span class="na">{{ tenant.status | default('N/A') }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>Total ({{ data.tenants | length }} tenants)</strong></td>
                        <td class="number"><strong style="color: var(--color-success);">${{ (data.rollup.total_cost if data.rollup and data.rollup.total_cost else 0) | format_number }}</strong></td>
                        <td class="number"><strong>{% if data.rollup and data.rollup.total_cost %}100%{% else %}-{% endif %}</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="chart-unavailable">
            <span class="icon">üìã</span>
            <p>No tenant billing data available</p>
        </div>
        {% endif %}
    </section>

    {# ================================================================
       DETAILED SKU BREAKDOWN BY TENANT
       ================================================================ #}
    {% if data.tenants and data.tenants | length > 0 %}
    <section class="dashboard-section">
        <h2>Detailed SKU Breakdown by Tenant</h2>

        {% for tenant in data.tenants %}
        <div class="tenant-card" {% if tenant.cost == 0 %}style="opacity: 0.7;"{% endif %}>
            <div class="tenant-header">
                <div>
                    <div class="tenant-name">{{ tenant.name }}</div>
                    <div style="font-size: 0.8rem; color: var(--color-text-muted);">
                        {{ tenant.skus | length if tenant.skus else 0 }} line items | {{ tenant.currency | default('usd') | upper }}
                    </div>
                </div>
                <div class="tenant-cost" {% if tenant.cost == 0 %}style="color: var(--color-text-muted);"{% endif %}>
                    ${{ tenant.cost | default(0) | format_number }}
                </div>
            </div>

            {% if tenant.skus and tenant.skus | length > 0 %}
                {% for sku in tenant.skus %}
                <div class="sku-row">
                    <span class="sku-name">{{ sku.description }}{% if sku.quantity %} ({{ sku.quantity }}){% endif %}</span>
                    <span class="sku-amount">${{ sku.amount | format_number }}</span>
                </div>
                {% endfor %}
            {% elif tenant.cost == 0 %}
            <div style="text-align: center; padding: 1rem; color: var(--color-text-muted);">
                No billable usage this period
            </div>
            {% else %}
            <div style="text-align: center; padding: 1rem; color: var(--color-text-muted);">
                SKU details not available
            </div>
            {% endif %}

            <div class="progress-bar">
                <div class="progress-fill" style="width: {% if data.rollup and data.rollup.total_cost and data.rollup.total_cost > 0 %}{{ ((tenant.cost | default(0)) / data.rollup.total_cost * 100) | round(1) }}{% else %}0{% endif %}%; background: var(--color-primary);"></div>
            </div>
        </div>
        {% endfor %}
    </section>
    {% endif %}

    {# ================================================================
       COST BY CATEGORY (if available)
       ================================================================ #}
    {% if data.categories and data.categories | length > 0 %}
    <section class="dashboard-section">
        <h2>Cost by Category (All Tenants)</h2>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
    </section>
    {% endif %}

    {# ================================================================
       WARNINGS AND ERRORS
       ================================================================ #}
    {% if warnings or errors %}
    <section class="dashboard-section warnings-section">
        <h2>Data Limitations & Warnings</h2>

        {% if warnings %}
        <div class="warning-list">
            {% for warning in warnings %}
            <div class="warning-item">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span>{{ warning }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if errors %}
        <div class="error-list">
            <h3>Organizations Without Billing Access</h3>
            {% for error in errors %}
            <div class="error-item">
                <strong>{{ error.org_name | default('Unknown') }}</strong>
                <p>{{ error.error_message | default('Permission denied') }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    <footer style="margin-top: 2rem; padding: 1rem; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: var(--radius-md); font-size: 0.875rem;">
        <strong>Data Accuracy:</strong> All billing figures sourced directly from LimaCharlie billing API.
        Organizations without billing.ctrl permission excluded.
        No data has been fabricated, estimated, or interpolated.
    </footer>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    {% if data.tenants and data.tenants | length > 0 %}
    // Cost Distribution Doughnut Chart
    new Chart(document.getElementById('costDistChart'), {
        type: 'doughnut',
        data: {
            labels: [{% for t in data.tenants %}'{{ t.name | truncate(20) }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for t in data.tenants %}{{ t.cost | default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#0ea5e9', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#14b8a6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '55%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: { label: (ctx) => ` ${ctx.label}: $${ctx.raw.toLocaleString()}` }
                }
            }
        }
    });

    // Status Distribution Doughnut Chart
    {# Count tenants by status #}
    {% set success_count = data.tenants | selectattr('status', 'equalto', 'success') | list | length %}
    {% set error_count = data.tenants | selectattr('status', 'equalto', 'error') | list | length %}
    {% set no_invoice_count = data.tenants | selectattr('status', 'equalto', 'no_invoice') | list | length %}
    new Chart(document.getElementById('statusDistChart'), {
        type: 'doughnut',
        data: {
            labels: ['Success ({{ success_count }})', 'Error ({{ error_count }})', 'No Invoice ({{ no_invoice_count }})'],
            datasets: [{
                data: [{{ success_count }}, {{ error_count }}, {{ no_invoice_count }}],
                backgroundColor: ['#22c55e', '#ef4444', '#94a3b8'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '55%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: { label: (ctx) => ` ${ctx.raw} organizations` }
                }
            }
        }
    });
    {% endif %}

    {% if data.categories and data.categories | length > 0 %}
    // Category Bar Chart
    new Chart(document.getElementById('categoryChart'), {
        type: 'bar',
        data: {
            labels: [{% for cat in data.categories %}'{{ cat.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for cat in data.categories %}{{ cat.amount }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#0ea5e9', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#14b8a6'],
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { callback: (v) => '$' + (v/1000).toFixed(0) + 'k' } }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
