{#
  Fleet Health Dashboard Template

  Displays sensor health, platform distribution, and detection activity across organizations.

  DATA ACCURACY GUARDRAILS:
  - This template ONLY displays data provided in the context
  - Missing data shows "N/A" or "Data unavailable"
  - All warnings are displayed in a dedicated section
  - No data is fabricated, estimated, or interpolated
  - Health percentages calculated only from provided online/total counts
#}
{% extends 'base.html.j2' %}

{% block title %}Fleet Health Dashboard - {{ metadata.time_window.days | default(7) }} Day Overview{% endblock %}

{% block extra_styles %}
<style>
    .header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #0284c7, #0ea5e9);
        color: #fff;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo svg { width: 48px; height: 48px; }
    .logo span { font-size: 1.5rem; font-weight: 700; }
    .meta { display: flex; gap: 2rem; font-size: 0.875rem; opacity: 0.9; }
    .meta dt { font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; }
    .meta dd { font-weight: 600; margin-top: 0.25rem; }

    .health-gauge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .health-value {
        font-size: 2.5rem;
        font-weight: 700;
    }
    .health-value.healthy { color: var(--color-success); }
    .health-value.warning { color: var(--color-warning); }
    .health-value.critical { color: var(--color-danger); }

    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    .status-dot.healthy { background: var(--color-success); }
    .status-dot.warning { background: var(--color-warning); }
    .status-dot.critical { background: var(--color-danger); }
    .status-dot.error { background: var(--color-text-muted); }

    .limit-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.5rem;
        background: #fef3c7;
        color: #92400e;
        border-radius: var(--radius-sm);
        font-size: 0.7rem;
        font-weight: 600;
    }

    .org-card {
        padding: 1rem;
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-md);
        margin-bottom: 0.75rem;
    }
    .org-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .org-name { font-weight: 600; }
    .org-metrics {
        display: flex;
        gap: 1.5rem;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }
    .org-metric { display: flex; align-items: center; gap: 0.25rem; }

    /* Expandable detail sections */
    .detail-expansion {
        margin-top: 1rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    .detail-summary {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: var(--color-bg);
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        user-select: none;
    }
    .detail-summary:hover {
        background: var(--color-border);
    }
    .detail-toggle-icon {
        font-size: 0.7rem;
        transition: transform 0.2s ease;
    }
    details[open] .detail-toggle-icon {
        transform: rotate(90deg);
    }
    .detail-content {
        padding: 1rem;
        background: var(--color-card);
    }
    .detail-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .detail-item {
        padding: 0.75rem;
        background: var(--color-bg);
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--color-primary);
    }
    .detail-item.limit-reached {
        border-left-color: var(--color-warning);
        background: #fffbeb;
    }
    .detail-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .detail-item-name {
        font-weight: 600;
        font-size: 0.9rem;
    }
    .detail-item-value {
        font-weight: 700;
        color: var(--color-primary);
    }
    .detail-item-bar {
        height: 6px;
        background: var(--color-border);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    .detail-item-fill {
        height: 100%;
        background: var(--color-primary);
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    .detail-item-meta {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    /* Severity badges and fills */
    .severity-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.375rem;
        border-radius: var(--radius-sm);
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-left: 0.5rem;
    }
    .severity-badge.severity-critical { background: #fef2f2; color: #991b1b; }
    .severity-badge.severity-high { background: #fff7ed; color: #9a3412; }
    .severity-badge.severity-medium { background: #fefce8; color: #854d0e; }
    .severity-badge.severity-low { background: #f0fdf4; color: #166534; }
    .severity-badge.severity-info { background: #eff6ff; color: #1e40af; }

    .detail-item.severity-critical { border-left-color: #dc2626; }
    .detail-item.severity-high { border-left-color: #ea580c; }
    .detail-item.severity-medium { border-left-color: #ca8a04; }
    .detail-item.severity-low { border-left-color: #16a34a; }
    .detail-item.severity-info { border-left-color: #2563eb; }

    .detail-item-fill.severity-fill-critical { background: #dc2626; }
    .detail-item-fill.severity-fill-high { background: #ea580c; }
    .detail-item-fill.severity-fill-medium { background: #ca8a04; }
    .detail-item-fill.severity-fill-low { background: #16a34a; }
    .detail-item-fill.severity-fill-info { background: #2563eb; }

    /* Organization expandable cards */
    .org-expandable-card {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        margin-bottom: 0.75rem;
        overflow: hidden;
    }
    .org-expandable-card.status-critical {
        border-left: 4px solid var(--color-danger);
    }
    .org-expandable-card.status-warning {
        border-left: 4px solid var(--color-warning);
    }
    .org-expandable-card.status-healthy {
        border-left: 4px solid var(--color-success);
    }
    .org-expandable-card.status-limited {
        border-left: 4px solid #f59e0b;
        background: #fffbeb;
    }
    .org-card-summary {
        display: grid;
        grid-template-columns: 2fr repeat(5, 1fr) auto;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        cursor: pointer;
        background: var(--color-card);
    }
    .org-card-summary:hover {
        background: var(--color-bg-secondary);
    }
    .org-card-name {
        font-weight: 600;
    }
    .org-card-metric {
        text-align: center;
    }
    .org-card-metric-value {
        font-weight: 700;
        font-size: 1rem;
    }
    .org-card-metric-label {
        font-size: 0.7rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
    }
    .org-card-toggle {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        transition: transform 0.2s;
    }
    details[open] .org-card-toggle {
        transform: rotate(90deg);
    }
    .org-card-details {
        padding: 1rem;
        background: var(--color-bg);
        border-top: 1px solid var(--color-border);
    }
    .org-detail-section {
        margin-bottom: 1rem;
    }
    .org-detail-section:last-child {
        margin-bottom: 0;
    }
    .org-detail-section h4 {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--color-text-secondary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .platform-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.5rem;
    }
    .platform-item {
        padding: 0.5rem;
        background: var(--color-card);
        border-radius: var(--radius-sm);
        border: 1px solid var(--color-border-light);
    }
    .platform-name {
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }
    .platform-stats {
        display: flex;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }
    .offline-sensor-list, .detection-list {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }
    .offline-sensor-item, .detection-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: var(--color-card);
        border-radius: var(--radius-sm);
        border: 1px solid var(--color-border-light);
        font-size: 0.85rem;
    }
    .offline-sensor-item {
        border-left: 3px solid var(--color-danger);
    }
    .sensor-hostname {
        font-weight: 500;
    }
    .sensor-meta {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }
    .detection-name {
        font-weight: 500;
    }
    .detection-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .detection-count {
        font-weight: 600;
        color: var(--color-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">

    {# ================================================================
       REPORT HEADER
       ================================================================ #}
    <header class="header">
        <div class="logo">
            <svg viewBox="0 0 48 48" fill="none"><rect width="48" height="48" rx="10" fill="rgba(255,255,255,0.2)"/><path d="M24 8c-8.8 0-16 7.2-16 16s7.2 16 16 16 16-7.2 16-16-7.2-16-16-16zm0 28c-6.6 0-12-5.4-12-12s5.4-12 12-12 12 5.4 12 12-5.4 12-12 12z" fill="white"/><path d="M24 16v8l6 6" stroke="white" stroke-width="3" stroke-linecap="round"/></svg>
            <span>LimaCharlie</span>
        </div>
        <div>
            <h1>Fleet Health Dashboard</h1>
            <dl class="meta">
                <div><dt>Time Window</dt><dd>{{ metadata.time_window.days | default(7) }} days</dd></div>
                <div><dt>Generated</dt><dd>{{ metadata.generated_at | default('N/A') }}</dd></div>
                <div><dt>Organizations</dt><dd>
                    {% if metadata.organizations %}
                        {{ metadata.organizations.successful | default(0) }} of {{ metadata.organizations.total | default(0) }}
                    {% else %}
                        {{ data.organizations | length if data.organizations else 'N/A' }}
                    {% endif %}
                </dd></div>
            </dl>
        </div>
    </header>

    {# ================================================================
       DETECTION LIMIT WARNING (if applicable)
       ================================================================ #}
    {% if data.rollup.detection_limit_reached %}
    <div class="alert-banner alert-banner-warning">
        <div class="alert-banner-title">
            <span>&#9888;</span> Detection Limit Reached
        </div>
        <p>
            {{ data.rollup.orgs_at_limit | default('Some') }} organization(s) hit the 5,000 detection limit.
            Actual detection counts may be higher than shown.
        </p>
    </div>
    {% endif %}

    {# ================================================================
       EXECUTIVE SUMMARY
       GUARDRAIL: All values come directly from data.rollup
       ================================================================ #}
    <section class="dashboard-section" aria-labelledby="summary-heading">
        <h2 id="summary-heading">Executive Summary</h2>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="card-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                        <path d="M8 21h8M12 17v4"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">
                        {% if data.rollup.total_sensors is defined %}
                            {{ data.rollup.total_sensors | default(0) }}
                        {% else %}
                            <span class="na">N/A</span>
                        {% endif %}
                    </span>
                    <span class="card-label">Total Sensors</span>
                    <span class="card-subvalue">Across all organizations</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon green">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value" style="color: var(--color-success);">
                        {% if data.rollup.online_sensors is defined %}
                            {{ data.rollup.online_sensors | default(0) }}
                        {% else %}
                            <span class="na">N/A</span>
                        {% endif %}
                    </span>
                    <span class="card-label">Online Sensors</span>
                    <span class="card-subvalue">Currently reporting</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon {% if data.rollup.health_percent is defined and data.rollup.health_percent >= 90 %}green{% elif data.rollup.health_percent is defined and data.rollup.health_percent >= 70 %}amber{% else %}red{% endif %}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value health-value {% if data.rollup.health_percent is defined and data.rollup.health_percent >= 90 %}healthy{% elif data.rollup.health_percent is defined and data.rollup.health_percent >= 70 %}warning{% else %}critical{% endif %}">
                        {% if data.rollup.health_percent is defined %}
                            {{ data.rollup.health_percent | round(1) }}%
                        {% elif data.rollup.online_sensors is defined and data.rollup.total_sensors is defined and data.rollup.total_sensors > 0 %}
                            {{ ((data.rollup.online_sensors / data.rollup.total_sensors) * 100) | round(1) }}%
                        {% else %}
                            <span class="na">N/A</span>
                        {% endif %}
                    </span>
                    <span class="card-label">Fleet Health</span>
                    <span class="card-subvalue">Online / Total</span>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon purple">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value">
                        {% if data.rollup.total_detections is defined %}
                            {{ data.rollup.total_detections | default(0) }}
                        {% else %}
                            <span class="na">N/A</span>
                        {% endif %}
                    </span>
                    <span class="card-label">Total Detections</span>
                    <span class="card-subvalue">Last {{ metadata.time_window.days | default(7) }} days</span>
                    {% if data.rollup.detection_limit_reached %}
                    <div class="card-warning">
                        &#9888; {{ data.rollup.orgs_at_limit | default('Some') }} org(s) at limit
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    {# ================================================================
       DISTRIBUTION CHARTS
       ================================================================ #}
    <section class="dashboard-section">
        <h2>Platform & Organization Distribution</h2>
        <div class="chart-grid two-column">
            <div class="chart-container">
                <h3 class="chart-title">Platform Distribution</h3>
                <p class="chart-subtitle">Sensors by operating system</p>
                {% if data.platforms and data.platforms | length > 0 %}
                <div class="chart-wrapper">
                    <canvas id="platformChart"></canvas>
                </div>
                {% else %}
                <div class="chart-unavailable">
                    <span class="icon">&#128202;</span>
                    <p>Platform data not available</p>
                </div>
                {% endif %}
            </div>

            <div class="chart-container" style="padding: 1rem;">
                <h3 class="chart-title">Organization Health</h3>
                <p class="chart-subtitle">Health status by organization</p>
                {% set orgs_with_health = data.organizations | selectattr('health', 'defined') | selectattr('health', 'ne', none) | list %}
                {% if orgs_with_health | length > 0 %}
                <div class="detail-list" style="max-height: 320px; overflow-y: auto;">
                    {% for org in orgs_with_health | sort(attribute='health', reverse=true) %}
                    <div class="detail-item" style="margin-bottom: 0.5rem; border-left-color: {% if org.health >= 90 %}var(--color-success){% elif org.health >= 70 %}var(--color-warning){% else %}var(--color-danger){% endif %};">
                        <div class="detail-item-header">
                            <span class="detail-item-name" style="font-size: 0.85rem;">{{ org.name }}</span>
                            <span class="detail-item-value health-value {% if org.health >= 90 %}healthy{% elif org.health >= 70 %}warning{% else %}critical{% endif %}" style="font-size: 0.85rem;">{{ org.health | round(1) }}%</span>
                        </div>
                        <div class="detail-item-bar" style="height: 4px;">
                            <div class="detail-item-fill" style="width: {{ org.health }}%; background: {% if org.health >= 90 %}var(--color-success){% elif org.health >= 70 %}var(--color-warning){% else %}var(--color-danger){% endif %};"></div>
                        </div>
                        <div class="detail-item-meta" style="margin-top: 0.25rem;">
                            <span>{{ org.sensors_online | default(0) }}/{{ org.sensors_total | default(0) }} online</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% elif data.organizations | length > 0 %}
                <div style="padding: 1rem; text-align: center; color: var(--color-text-muted);">
                    <p>Health data unavailable (limited permissions)</p>
                </div>
                {% else %}
                <div class="chart-unavailable">
                    <span class="icon">&#128202;</span>
                    <p>Organization data not available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </section>

    {# ================================================================
       TOP DETECTION CATEGORIES - List Only
       ================================================================ #}
    {% if data.top_categories and data.top_categories | length > 0 %}
    {% set total_category_detections = data.top_categories | sum(attribute='value') %}
    <section class="dashboard-section">
        <h2>Top Detection Categories</h2>
        <p class="chart-subtitle" style="margin-bottom: 1rem;">{{ total_category_detections }} total detections across {{ data.top_categories | length }} categories</p>
        <div class="detail-list">
            {% for cat in data.top_categories %}
            <div class="detail-item severity-{{ cat.severity | default('info') }}">
                <div class="detail-item-header">
                    <span class="detail-item-name">
                        {{ cat.label }}
                        {% if cat.severity %}
                        <span class="severity-badge severity-{{ cat.severity }}">{{ cat.severity | upper }}</span>
                        {% endif %}
                    </span>
                    <span class="detail-item-value">{{ cat.value }} detections</span>
                </div>
                <div class="detail-item-bar">
                    <div class="detail-item-fill severity-fill-{{ cat.severity | default('info') }}" style="width: {{ (cat.value / (data.top_categories[0].value or 1) * 100) | round(1) }}%;"></div>
                </div>
                <div class="detail-item-meta">
                    {% if total_category_detections > 0 %}
                    <span>{{ ((cat.value / total_category_detections) * 100) | round(1) }}% of total</span>
                    {% endif %}
                    {% if cat.affected_orgs %}
                    <span>• {{ cat.affected_orgs }} org{{ 's' if cat.affected_orgs != 1 else '' }}</span>
                    {% endif %}
                    {% if cat.affected_hosts %}
                    <span>• {{ cat.affected_hosts }} host{{ 's' if cat.affected_hosts != 1 else '' }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# ================================================================
       TOP ORGANIZATIONS BY DETECTIONS - List Only
       ================================================================ #}
    {% if data.top_orgs_by_detections and data.top_orgs_by_detections | length > 0 %}
    {% set total_org_detections = data.top_orgs_by_detections | sum(attribute='value') %}
    <section class="dashboard-section">
        <h2>Organizations by Detection Volume</h2>
        <p class="chart-subtitle" style="margin-bottom: 1rem;">{{ data.top_orgs_by_detections | length }} organizations with detections</p>
        <div class="detail-list">
            {% for org in data.top_orgs_by_detections %}
            <div class="detail-item {% if org.limit_reached %}limit-reached{% endif %}">
                <div class="detail-item-header">
                    <span class="detail-item-name">
                        {{ org.name }}
                        {% if org.limit_reached %}
                        <span class="limit-badge">LIMIT</span>
                        {% endif %}
                    </span>
                    <span class="detail-item-value">{{ org.value }} detections</span>
                </div>
                <div class="detail-item-bar">
                    <div class="detail-item-fill" style="width: {{ (org.value / (data.top_orgs_by_detections[0].value or 1) * 100) | round(1) }}%;"></div>
                </div>
                <div class="detail-item-meta">
                    {% if org.sensors %}
                    <span>{{ org.sensors }} sensors</span>
                    {% endif %}
                    {% if org.top_category %}
                    <span>• Top: {{ org.top_category }}</span>
                    {% endif %}
                    {% if total_org_detections > 0 and org.value > 0 %}
                    <span>• {{ ((org.value / total_org_detections) * 100) | round(1) }}% of total</span>
                    {% endif %}
                    {% if org.limit_reached %}
                    <span style="color: var(--color-warning);">• Actual count may be higher</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# ================================================================
       OFFLINE SENSORS SUMMARY
       ================================================================ #}
    {% if data.offline_summary and data.offline_summary.total_offline > 0 %}
    <section class="dashboard-section">
        <h2>Offline Sensors Analysis</h2>

        <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="summary-card">
                <div class="card-icon red">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value" style="color: var(--color-danger);">{{ data.offline_summary.total_offline }}</span>
                    <span class="card-label">Total Offline</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon amber">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value" style="color: var(--color-warning);">{{ data.offline_summary.offline_7_plus_days | default(0) }}</span>
                    <span class="card-label">Offline 7+ Days</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon red">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="card-content">
                    <span class="card-value" style="color: var(--color-danger);">{{ data.offline_summary.offline_30_plus_days | default(0) }}</span>
                    <span class="card-label">Offline 30+ Days</span>
                </div>
            </div>
        </div>

        {% if data.offline_summary.by_platform %}
        <details class="detail-expansion" open>
            <summary class="detail-summary">
                <span class="detail-toggle-icon">▶</span>
                Offline by platform
            </summary>
            <div class="detail-content">
                <div class="detail-list">
                    {% for plat in data.offline_summary.by_platform %}
                    <div class="detail-item">
                        <div class="detail-item-header">
                            <span class="detail-item-name">{{ plat.platform }}</span>
                            <span class="detail-item-value">{{ plat.count }} offline</span>
                        </div>
                        <div class="detail-item-bar">
                            <div class="detail-item-fill" style="width: {{ (plat.count / data.offline_summary.total_offline * 100) | round(1) }}%; background: var(--color-danger);"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </details>
        {% endif %}
    </section>
    {% endif %}

    {# ================================================================
       PER-ORGANIZATION EXPANDABLE CARDS
       ================================================================ #}
    <section class="dashboard-section">
        <h2>Organization Details</h2>
        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 1rem;">
            Click any organization to expand and see detailed platform breakdown, offline sensors, and detection information.
        </p>

        {% if data.organizations and data.organizations | length > 0 %}

        {# Summary row header #}
        <div style="display: grid; grid-template-columns: 2fr repeat(5, 1fr) auto; gap: 1rem; padding: 0.5rem 1rem; font-size: 0.7rem; text-transform: uppercase; color: var(--color-text-muted); border-bottom: 1px solid var(--color-border); margin-bottom: 0.5rem;">
            <div>Organization</div>
            <div style="text-align: center;">Sensors</div>
            <div style="text-align: center;">Online</div>
            <div style="text-align: center;">Offline</div>
            <div style="text-align: center;">Health</div>
            <div style="text-align: center;">Detections</div>
            <div style="width: 1.5rem;"></div>
        </div>

        {% for org in data.organizations | sort(attribute='sensors_total', reverse=true) %}
        <details class="org-expandable-card {% if org.status == 'limited_access' %}status-limited{% elif org.status == 'critical' %}status-critical{% elif org.status == 'warning' %}status-warning{% elif org.status == 'healthy' %}status-healthy{% endif %}">
            <summary class="org-card-summary">
                <div class="org-card-name">
                    {{ org.name | default('N/A') }}
                    {% if org.status == 'limited_access' %}
                    <span style="font-size: 0.75rem; color: #92400e; font-weight: normal;">⚠️ Limited</span>
                    {% endif %}
                </div>
                <div class="org-card-metric">
                    <div class="org-card-metric-value">{{ org.sensors_total | default(0) }}{% if org.status == 'limited_access' %}*{% endif %}</div>
                    <div class="org-card-metric-label">Sensors</div>
                </div>
                <div class="org-card-metric">
                    <div class="org-card-metric-value" style="color: var(--color-success);">
                        {% if org.status == 'limited_access' %}—{% else %}{{ org.sensors_online | default(0) }}{% endif %}
                    </div>
                    <div class="org-card-metric-label">Online</div>
                </div>
                <div class="org-card-metric">
                    <div class="org-card-metric-value" style="color: var(--color-danger);">
                        {% if org.status == 'limited_access' %}—{% else %}{{ org.sensors_offline | default(0) }}{% endif %}
                    </div>
                    <div class="org-card-metric-label">Offline</div>
                </div>
                <div class="org-card-metric">
                    <div class="org-card-metric-value {% if org.health is defined and org.health is not none and org.health >= 90 %}healthy{% elif org.health is defined and org.health is not none and org.health >= 70 %}warning{% elif org.health is defined and org.health is not none %}critical{% endif %}">
                        {% if org.status == 'limited_access' %}—{% elif org.health is defined and org.health is not none %}{{ org.health | round(1) }}%{% else %}N/A{% endif %}
                    </div>
                    <div class="org-card-metric-label">Health</div>
                </div>
                <div class="org-card-metric">
                    <div class="org-card-metric-value">
                        {% if org.status == 'limited_access' %}—
                        {% elif org.detections is not none %}{{ org.detections }}{% if org.detection_limit_reached %}<span class="limit-badge" style="margin-left: 0.25rem; font-size: 0.6rem;">!</span>{% endif %}
                        {% else %}N/A{% endif %}
                    </div>
                    <div class="org-card-metric-label">Detections</div>
                </div>
                <span class="org-card-toggle">▶</span>
            </summary>
            <div class="org-card-details">
                {% if org.status == 'limited_access' %}
                <div class="org-detail-section">
                    <div style="padding: 1rem; background: #fffbeb; border-radius: var(--radius-sm); color: #92400e;">
                        <strong>⚠️ Limited Access</strong>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                            {% if org.status_reason %}{{ org.status_reason }}{% else %}Some data is unavailable due to permission restrictions.{% endif %}
                        </p>
                        {% if org.platforms and org.platforms | length > 0 %}
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">Platform counts are available but online/offline status cannot be determined.</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# Platform Breakdown #}
                {% if org.platforms and org.platforms | length > 0 %}
                <div class="org-detail-section">
                    <h4>Platform Breakdown</h4>
                    <div class="platform-grid">
                        {% for plat in org.platforms %}
                        <div class="platform-item">
                            <div class="platform-name">{{ plat.name }}</div>
                            <div class="platform-stats">
                                <span>{{ plat.count }} total</span>
                                {% if plat.online is defined %}
                                <span style="color: var(--color-success);">{{ plat.online }} online</span>
                                {% endif %}
                                {% if plat.offline is defined and plat.offline > 0 %}
                                <span style="color: var(--color-danger);">{{ plat.offline }} offline</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# Top Detections #}
                {% if org.top_detections and org.top_detections | length > 0 %}
                <div class="org-detail-section">
                    <h4>Top Detections</h4>
                    <div class="detection-list">
                        {% for det in org.top_detections %}
                        <div class="detection-item">
                            <div>
                                <span class="detection-name">{{ det.name }}</span>
                                {% if det.severity %}
                                <span class="severity-badge severity-{{ det.severity }}">{{ det.severity | upper }}</span>
                                {% endif %}
                                {% if det.host %}
                                <span class="sensor-meta" style="margin-left: 0.5rem;">on {{ det.host }}</span>
                                {% endif %}
                            </div>
                            <div class="detection-meta">
                                <span class="detection-count">{{ det.count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# Top Offline Sensors #}
                {% if org.top_offline_sensors and org.top_offline_sensors | length > 0 %}
                <div class="org-detail-section">
                    <h4>Offline Sensors (Top {{ org.top_offline_sensors | length }})</h4>
                    <div class="offline-sensor-list">
                        {% for sensor in org.top_offline_sensors %}
                        <div class="offline-sensor-item">
                            <div>
                                <span class="sensor-hostname">{{ sensor.hostname }}</span>
                                <span class="sensor-meta"> • {{ sensor.platform }}</span>
                            </div>
                            <div class="sensor-meta">
                                {% if sensor.days_offline %}
                                <span style="color: {% if sensor.days_offline >= 7 %}var(--color-danger){% else %}var(--color-warning){% endif %};">
                                    {{ sensor.days_offline }} day{{ 's' if sensor.days_offline != 1 else '' }} offline
                                </span>
                                {% elif sensor.last_seen %}
                                <span>Last: {{ sensor.last_seen }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# No additional details #}
                {% if not org.platforms and not org.top_detections and not org.top_offline_sensors and org.status != 'limited_access' %}
                <div style="padding: 1rem; text-align: center; color: var(--color-text-muted);">
                    <p>No additional detail data available for this organization.</p>
                </div>
                {% endif %}
            </div>
        </details>
        {% endfor %}

        {# Summary footer #}
        <div style="display: grid; grid-template-columns: 2fr repeat(5, 1fr) auto; gap: 1rem; padding: 1rem; background: var(--color-bg-secondary); border-radius: var(--radius-md); margin-top: 0.5rem; font-weight: 600;">
            <div>Total ({{ data.organizations | length }} orgs)</div>
            <div style="text-align: center;">{{ data.rollup.total_sensors | default(0) }}</div>
            <div style="text-align: center; color: var(--color-success);">{{ data.rollup.online_sensors | default(0) }}</div>
            <div style="text-align: center; color: var(--color-danger);">{{ data.rollup.offline_sensors | default(0) }}</div>
            <div style="text-align: center;">{% if data.rollup.health_percent is defined %}{{ data.rollup.health_percent | round(1) }}%{% endif %}</div>
            <div style="text-align: center;">{{ data.rollup.total_detections | default(0) }}</div>
            <div style="width: 1.5rem;"></div>
        </div>
        {% else %}
        <div class="chart-unavailable">
            <span class="icon">&#128203;</span>
            <p>No organization data available</p>
        </div>
        {% endif %}
    </section>

    {# ================================================================
       WARNINGS AND ERRORS
       ================================================================ #}
    {% if warnings or errors %}
    <section class="dashboard-section warnings-section">
        <h2>Data Limitations & Warnings</h2>

        {% if warnings %}
        <div class="warning-list">
            {% for warning in warnings %}
            <div class="warning-item">
                <span class="warning-icon">&#9888;</span>
                <span>{{ warning }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if errors %}
        <div class="error-list">
            <h3>Organizations With Errors</h3>
            {% for error in errors %}
            <div class="error-item">
                <strong>{{ error.org_name | default('Unknown') }}</strong>
                <p>{{ error.error_message | default('Data collection failed') }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    {# ================================================================
       DATA PROVENANCE FOOTER
       ================================================================ #}
    <footer class="data-provenance">
        <h3>Data Provenance</h3>
        <dl class="provenance-list">
            <div>
                <dt>Generated</dt>
                <dd>{{ metadata.generated_at | default('N/A') }}</dd>
            </div>
            <div>
                <dt>Time Window</dt>
                <dd>{{ metadata.time_window.start_display | default('N/A') }} to {{ metadata.time_window.end_display | default('N/A') }}</dd>
            </div>
            <div>
                <dt>Organizations</dt>
                <dd>
                    {% if metadata.organizations %}
                        {{ metadata.organizations.successful | default(0) }} of {{ metadata.organizations.total | default(0) }}
                        ({{ metadata.organizations.success_rate | default(0) | round(1) }}% success)
                    {% else %}
                        {{ data.organizations | length if data.organizations else 'N/A' }}
                    {% endif %}
                </dd>
            </div>
            <div>
                <dt>Data Source</dt>
                <dd>LimaCharlie API</dd>
            </div>
        </dl>
        <div class="accuracy-statement">
            <p><strong>Data Accuracy:</strong> All values shown are from actual API responses.
            No data has been estimated, interpolated, or fabricated.
            Health percentages calculated as online/total sensors.</p>
        </div>
    </footer>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    {% if data.platforms and data.platforms | length > 0 %}
    // Platform Distribution Donut Chart
    LC.charts.pie(
        [{% for p in data.platforms %}{ label: '{{ p.name }}', value: {{ p.count }} }{% if not loop.last %}, {% endif %}{% endfor %}],
        { id: 'platformChart', donut: true }
    );
    {% endif %}


</script>
{% endblock %}
