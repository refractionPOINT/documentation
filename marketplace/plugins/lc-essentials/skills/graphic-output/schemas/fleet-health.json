{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Fleet Health Dashboard Data",
  "description": "Schema for data input to the fleet-health template. Visualizes sensor health, platform distribution, and detection activity across multiple organizations. All values must come from actual LimaCharlie API responses - no fabrication allowed.",
  "type": "object",
  "required": ["metadata", "data"],
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Report metadata - when and how data was collected",
      "required": ["generated_at", "time_window"],
      "properties": {
        "generated_at": {
          "type": "string",
          "description": "ISO 8601 timestamp when data was collected",
          "examples": ["2025-12-10T14:32:45Z"]
        },
        "time_window": {
          "type": "object",
          "description": "Time range for detection data",
          "required": ["start_display", "end_display", "days"],
          "properties": {
            "start": {
              "type": "integer",
              "description": "Start timestamp in Unix epoch seconds"
            },
            "end": {
              "type": "integer",
              "description": "End timestamp in Unix epoch seconds"
            },
            "start_display": {
              "type": "string",
              "description": "Human-readable start time",
              "examples": ["2025-12-03 00:00:00 UTC"]
            },
            "end_display": {
              "type": "string",
              "description": "Human-readable end time",
              "examples": ["2025-12-10 23:59:59 UTC"]
            },
            "days": {
              "type": "integer",
              "description": "Number of days in the time window",
              "examples": [7, 14, 30]
            }
          }
        },
        "organizations": {
          "type": "object",
          "description": "Organization processing summary",
          "properties": {
            "total": {
              "type": "integer",
              "description": "Total number of organizations attempted"
            },
            "successful": {
              "type": "integer",
              "description": "Number of organizations with full data access"
            },
            "limited_access": {
              "type": "integer",
              "description": "Number of organizations with limited permissions (partial data)"
            },
            "failed": {
              "type": "integer",
              "description": "Number of organizations that failed data collection completely"
            },
            "success_rate": {
              "type": "number",
              "description": "Percentage of organizations successfully processed"
            }
          }
        }
      }
    },
    "data": {
      "type": "object",
      "description": "Report data containing rollup totals and per-organization details",
      "required": ["rollup"],
      "properties": {
        "rollup": {
          "type": "object",
          "description": "Aggregate totals across all organizations - displayed in summary cards",
          "required": ["total_sensors", "online_sensors"],
          "properties": {
            "total_sensors": {
              "type": "integer",
              "description": "Total sensor count across all organizations",
              "examples": [1500, 5000]
            },
            "online_sensors": {
              "type": "integer",
              "description": "Number of sensors currently online",
              "examples": [1350, 4500]
            },
            "offline_sensors": {
              "type": "integer",
              "description": "Number of sensors currently offline (total - online)",
              "examples": [150, 500]
            },
            "health_percent": {
              "type": "number",
              "description": "Fleet-wide health percentage (online/total * 100)",
              "examples": [90.0, 95.5]
            },
            "total_detections": {
              "type": "integer",
              "description": "Total detections across all organizations in time window",
              "examples": [12500, 50000]
            },
            "detection_limit_reached": {
              "type": "boolean",
              "description": "Whether any organization hit the 5000 detection limit"
            },
            "orgs_at_limit": {
              "type": "integer",
              "description": "Number of organizations that hit the detection limit"
            }
          }
        },
        "platforms": {
          "type": "array",
          "description": "Sensor count breakdown by platform - displayed as donut chart",
          "items": {
            "type": "object",
            "required": ["name", "count"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Platform name (Windows, Linux, macOS, Chrome, USP Adapter, etc.)",
                "examples": ["Windows", "Linux", "macOS"]
              },
              "count": {
                "type": "integer",
                "description": "Number of sensors on this platform"
              },
              "percent": {
                "type": "number",
                "description": "Percentage of total sensors"
              }
            }
          }
        },
        "organizations": {
          "type": "array",
          "description": "Per-organization health details - displayed in sortable table",
          "items": {
            "type": "object",
            "required": ["name", "oid"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Organization display name",
                "examples": ["Acme Corp", "TPS Reporting Solutions"]
              },
              "oid": {
                "type": "string",
                "format": "uuid",
                "description": "Organization ID"
              },
              "sensors_total": {
                "type": "integer",
                "description": "Total sensor count for this organization"
              },
              "sensors_online": {
                "type": "integer",
                "description": "Online sensor count"
              },
              "sensors_offline": {
                "type": "integer",
                "description": "Offline sensor count"
              },
              "health": {
                "type": "number",
                "description": "Health percentage (0-100)"
              },
              "detections": {
                "type": ["integer", "null"],
                "description": "Detection count in time window (null if data unavailable)"
              },
              "detection_limit_reached": {
                "type": "boolean",
                "description": "Whether this org hit the 5000 detection limit"
              },
              "status": {
                "type": "string",
                "enum": ["healthy", "warning", "critical", "limited_access", "error"],
                "description": "Health status: healthy (>=90%), warning (70-89%), critical (<70%), limited_access (missing permissions), error (no data)"
              },
              "status_reason": {
                "type": "string",
                "description": "Explanation for limited_access or error status"
              },
              "platforms": {
                "type": "array",
                "description": "Per-organization platform breakdown with online/offline counts",
                "items": {
                  "type": "object",
                  "required": ["name", "count"],
                  "properties": {
                    "name": { "type": "string", "description": "Platform name" },
                    "count": { "type": "integer", "description": "Total sensors on this platform" },
                    "online": { "type": "integer", "description": "Online sensors (optional if limited_access)" },
                    "offline": { "type": "integer", "description": "Offline sensors (optional if limited_access)" }
                  }
                }
              },
              "top_detections": {
                "type": "array",
                "description": "Top detections for this organization",
                "items": {
                  "type": "object",
                  "required": ["name", "count"],
                  "properties": {
                    "name": { "type": "string", "description": "Detection rule/category name" },
                    "count": { "type": "integer", "description": "Number of times detected" },
                    "severity": { "type": "string", "enum": ["critical", "high", "medium", "low", "info"] },
                    "host": { "type": "string", "description": "Primary affected host" }
                  }
                }
              },
              "top_offline_sensors": {
                "type": "array",
                "description": "Top offline sensors for this organization",
                "items": {
                  "type": "object",
                  "required": ["hostname", "platform"],
                  "properties": {
                    "hostname": { "type": "string", "description": "Sensor hostname" },
                    "platform": { "type": "string", "description": "Sensor platform" },
                    "last_seen": { "type": "string", "description": "Last seen timestamp (display format)" },
                    "days_offline": { "type": "integer", "description": "Days since last seen" }
                  }
                }
              }
            }
          }
        },
        "top_categories": {
          "type": "array",
          "description": "Top detection categories across all organizations - displayed as list with severity",
          "items": {
            "type": "object",
            "required": ["label", "value"],
            "properties": {
              "label": {
                "type": "string",
                "description": "Detection category name (from source_rule or cat field)"
              },
              "value": {
                "type": "integer",
                "description": "Total detection count for this category"
              },
              "severity": {
                "type": "string",
                "enum": ["critical", "high", "medium", "low", "info"],
                "description": "Severity level of this detection category"
              },
              "affected_orgs": {
                "type": "integer",
                "description": "Number of organizations with this detection"
              },
              "affected_hosts": {
                "type": "integer",
                "description": "Number of unique hosts with this detection"
              }
            }
          }
        },
        "top_orgs_by_detections": {
          "type": "array",
          "description": "Top organizations by detection volume - displayed as list",
          "items": {
            "type": "object",
            "required": ["name", "value"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Organization name"
              },
              "value": {
                "type": "integer",
                "description": "Detection count"
              },
              "limit_reached": {
                "type": "boolean",
                "description": "Whether this org hit the detection limit"
              },
              "top_category": {
                "type": ["string", "null"],
                "description": "Most common detection category for this org"
              },
              "sensors": {
                "type": "integer",
                "description": "Total sensor count for this org"
              }
            }
          }
        },
        "offline_summary": {
          "type": "object",
          "description": "Summary of offline sensors across all organizations",
          "properties": {
            "total_offline": {
              "type": "integer",
              "description": "Total number of offline sensors"
            },
            "offline_7_plus_days": {
              "type": "integer",
              "description": "Sensors offline for 7 or more days"
            },
            "offline_30_plus_days": {
              "type": "integer",
              "description": "Sensors offline for 30 or more days"
            },
            "by_platform": {
              "type": "array",
              "description": "Offline sensor counts by platform",
              "items": {
                "type": "object",
                "required": ["platform", "count"],
                "properties": {
                  "platform": { "type": "string" },
                  "count": { "type": "integer" }
                }
              }
            }
          }
        }
      }
    },
    "warnings": {
      "type": "array",
      "description": "Data collection warnings - displayed in yellow alert box",
      "items": {
        "type": "string"
      },
      "examples": [
        ["4 organizations hit the 5000 detection limit", "Detection counts are approximate for 2 orgs"]
      ]
    },
    "errors": {
      "type": "array",
      "description": "Per-organization errors - displayed in collapsible error section",
      "items": {
        "type": "object",
        "properties": {
          "org_name": {
            "type": "string",
            "description": "Name of the organization that failed"
          },
          "oid": {
            "type": "string",
            "description": "Organization ID (UUID)"
          },
          "error_message": {
            "type": "string",
            "description": "Error description"
          }
        }
      }
    }
  },
  "examples": [
    {
      "metadata": {
        "generated_at": "2025-12-10T14:32:45Z",
        "time_window": {
          "start": 1733270400,
          "end": 1733875199,
          "start_display": "2025-12-03 00:00:00 UTC",
          "end_display": "2025-12-10 23:59:59 UTC",
          "days": 7
        },
        "organizations": {
          "total": 24,
          "successful": 20,
          "limited_access": 2,
          "failed": 2,
          "success_rate": 91.7
        }
      },
      "data": {
        "rollup": {
          "total_sensors": 1500,
          "online_sensors": 1350,
          "offline_sensors": 150,
          "health_percent": 90.0,
          "total_detections": 12500,
          "detection_limit_reached": true,
          "orgs_at_limit": 3
        },
        "platforms": [
          {"name": "Windows", "count": 850, "percent": 56.7},
          {"name": "Linux", "count": 400, "percent": 26.7},
          {"name": "macOS", "count": 150, "percent": 10.0},
          {"name": "USP Adapter", "count": 100, "percent": 6.6}
        ],
        "organizations": [
          {
            "name": "TPS Reporting Solutions",
            "oid": "aac9c41d-e0a3-4e7e-88b8-33936ab93238",
            "sensors_total": 150,
            "sensors_online": 142,
            "sensors_offline": 8,
            "health": 94.7,
            "detections": 1250,
            "detection_limit_reached": false,
            "status": "healthy",
            "platforms": [
              {"name": "Windows", "count": 100, "online": 95, "offline": 5},
              {"name": "Linux", "count": 50, "online": 47, "offline": 3}
            ],
            "top_detections": [
              {"name": "Suspicious Process", "count": 5, "severity": "medium", "host": "workstation-01"}
            ],
            "top_offline_sensors": [
              {"hostname": "laptop-042", "platform": "windows", "last_seen": "2025-12-08 10:00 UTC", "days_offline": 2}
            ]
          },
          {
            "name": "Acme Corp",
            "oid": "cdadbaa4-265d-4549-9686-990731ee4091",
            "sensors_total": 200,
            "sensors_online": 150,
            "sensors_offline": 50,
            "health": 75.0,
            "detections": 5000,
            "detection_limit_reached": true,
            "status": "warning",
            "platforms": [
              {"name": "Windows", "count": 180, "online": 140, "offline": 40},
              {"name": "macOS", "count": 20, "online": 10, "offline": 10}
            ],
            "top_detections": [
              {"name": "Network Scan Detected", "count": 150, "severity": "high", "host": "server-db-01"}
            ],
            "top_offline_sensors": [
              {"hostname": "remote-laptop-001", "platform": "windows", "last_seen": "2025-12-01 08:00 UTC", "days_offline": 9}
            ]
          },
          {
            "name": "Limited Corp",
            "oid": "eecc6630-20d1-4fd6-b16c-245c58a6d58e",
            "sensors_total": 500,
            "sensors_online": null,
            "sensors_offline": null,
            "health": null,
            "detections": null,
            "detection_limit_reached": false,
            "status": "limited_access",
            "status_reason": "Sensor online/offline status not available - may require sensor.list.* permission",
            "platforms": [
              {"name": "Windows", "count": 400},
              {"name": "Linux", "count": 100}
            ]
          }
        ],
        "top_categories": [
          {"label": "SENSITIVE_PROCESS_ACCESS", "value": 3500, "severity": "high", "affected_orgs": 8, "affected_hosts": 45},
          {"label": "NEW_PROCESS", "value": 2800, "severity": "info", "affected_orgs": 15, "affected_hosts": 120},
          {"label": "NETWORK_CONNECTIONS", "value": 1500, "severity": "medium", "affected_orgs": 5, "affected_hosts": 22}
        ],
        "top_orgs_by_detections": [
          {"name": "Acme Corp", "value": 5000, "limit_reached": true, "top_category": "Network Scan Detected", "sensors": 200},
          {"name": "GlobalTech", "value": 3200, "limit_reached": false, "top_category": "NEW_PROCESS", "sensors": 150}
        ],
        "offline_summary": {
          "total_offline": 150,
          "offline_7_plus_days": 25,
          "offline_30_plus_days": 5,
          "by_platform": [
            {"platform": "Windows", "count": 100},
            {"platform": "Linux", "count": 30},
            {"platform": "macOS", "count": 20}
          ]
        }
      },
      "warnings": [
        "3 organizations hit the 5000 detection limit - actual counts may be higher",
        "2 organizations have limited access permissions - sensor health data unavailable"
      ],
      "errors": [
        {
          "org_name": "Test Org",
          "oid": "ddcc6630-20d1-4fd6-b16c-245c58a6d58e",
          "error_message": "Permission denied: missing sensor.list permission"
        }
      ]
    }
  ]
}
